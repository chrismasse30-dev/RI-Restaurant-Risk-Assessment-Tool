<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RI Restaurant Risk Assessment Tool - Enhanced Predictive Analytics</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f9fb;
        }
        .btn-predict {
            background-image: linear-gradient(to right, #10b981, #059669);
            transition: all 0.2s ease-in-out;
            box-shadow: 0 4px 6px -1px rgba(16, 185, 129, 0.4), 0 2px 4px -2px rgba(16, 185, 129, 0.4);
        }
        .btn-predict:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 15px -3px rgba(16, 185, 129, 0.3), 0 4px 6px -4px rgba(16, 185, 129, 0.3);
        }
        .btn-upload {
            background-image: linear-gradient(to right, #667eea, #764ba2);
            transition: all 0.2s ease-in-out;
        }
        .btn-upload:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 15px -3px rgba(102, 126, 234, 0.3);
        }
        .btn-cgd {
            background-image: linear-gradient(to right, #f59e0b, #d97706);
            transition: all 0.2s ease-in-out;
        }
        .btn-cgd:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 15px -3px rgba(245, 158, 11, 0.3);
        }
        .input-style {
            padding: 0.5rem;
            border: 1px solid #e5e7eb;
            border-radius: 0.5rem;
            width: 100%;
            background-color: white;
            transition: border-color 0.2s;
        }
        .input-style:focus {
            border-color: #10b981;
            outline: none;
        }
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-top: 4px solid #10b981;
            border-radius: 50%;
            width: 1.5rem;
            height: 1.5rem;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .file-upload-area {
            border: 2px dashed #cbd5e0;
            transition: all 0.3s;
        }
        .file-upload-area:hover {
            border-color: #667eea;
            background-color: #f7fafc;
        }
        .file-upload-area.drag-over {
            border-color: #667eea;
            background-color: #eef2ff;
        }
        .keyword-badge {
            display: inline-block;
            padding: 0.25rem 0.5rem;
            margin: 0.25rem;
            border-radius: 0.25rem;
            font-size: 0.75rem;
            font-weight: 600;
        }
        .keyword-badge.high { background-color: #fee2e2; color: #991b1b; }
        .keyword-badge.medium { background-color: #fef3c7; color: #92400e; }
        .keyword-badge.low { background-color: #dbeafe; color: #1e40af; }
        .source-badge {
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
            padding: 0.25rem 0.5rem;
            border-radius: 0.375rem;
            font-size: 0.75rem;
            font-weight: 600;
            text-decoration: none;
            transition: all 0.2s;
        }
        .source-badge.yelp {
            background-color: #d32323;
            color: white;
        }
        .source-badge.yelp:hover {
            background-color: #b51e1e;
        }
        .source-badge.google {
            background-color: #4285f4;
            color: white;
        }
        .source-badge.google:hover {
            background-color: #3367d6;
        }
        .prediction-meter {
            height: 12px;
            background: linear-gradient(to right, #10b981, #f59e0b, #ef4444);
            border-radius: 6px;
            position: relative;
        }
        .prediction-indicator {
            position: absolute;
            top: -8px;
            width: 0;
            height: 0;
            border-left: 6px solid transparent;
            border-right: 6px solid transparent;
            border-top: 8px solid #1f2937;
            transition: left 0.5s ease;
        }
        .timeline-item {
            border-left: 3px solid #e5e7eb;
            padding-left: 1rem;
            margin-left: 0.5rem;
        }
        .timeline-item.active {
            border-left-color: #3b82f6;
        }
        .confidence-bar {
            height: 8px;
            background-color: #e5e7eb;
            border-radius: 4px;
            overflow: hidden;
        }
        .confidence-fill {
            height: 100%;
            background: linear-gradient(to right, #10b981, #059669);
            transition: width 0.5s ease;
        }
    </style>
</head>
<body class="p-4 md:p-8">
    <div class="max-w-7xl mx-auto bg-white shadow-xl rounded-xl p-4 md:p-6">

        <!-- Header -->
        <header class="text-center mb-6">
            <h1 class="text-3xl md:text-4xl font-extrabold text-gray-800">üçΩ RI Restaurant Risk Assessment Tool</h1>
            <p class="text-gray-500 mt-1 text-base">Enhanced Predictive Analytics & Consumer Feedback Analysis</p>
            
            <!-- Data Freshness Indicator -->
            <div id="dataFreshnessAlert" class="hidden mt-3 mx-auto max-w-2xl">
                <div class="bg-blue-50 border-l-4 border-blue-500 p-3 rounded">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center gap-2">
                            <svg class="w-5 h-5 text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                            <div class="text-left">
                                <p class="text-sm font-semibold text-blue-800">Data Loaded: <span id="dataLoadTime">--</span></p>
                                <p class="text-xs text-blue-600">Last updated from RI Health Inspection Portal</p>
                            </div>
                        </div>
                        <a href="https://ri.healthinspections.us/ri/" target="_blank" class="text-xs font-semibold text-blue-600 hover:text-blue-800 underline">Check for Updates ‚Üí</a>
                    </div>
                </div>
            </div>
            
            <!-- Data Staleness Warning -->
            <div id="dataStaleWarning" class="hidden mt-3 mx-auto max-w-2xl">
                <div class="bg-yellow-50 border-l-4 border-yellow-500 p-3 rounded">
                    <div class="flex items-center gap-2">
                        <svg class="w-5 h-5 text-yellow-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
                        </svg>
                        <div class="text-left flex-1">
                            <p class="text-sm font-semibold text-yellow-800">‚ö†Ô∏è Data may be outdated</p>
                            <p class="text-xs text-yellow-600">Loaded <span id="dataAgeText">--</span> ago. RI Health updates daily.</p>
                        </div>
                        <button id="refreshDataBtn" class="text-xs font-semibold bg-yellow-500 text-white px-3 py-1 rounded hover:bg-yellow-600">
                            Refresh Data
                        </button>
                    </div>
                </div>
            </div>
        </header>

        <!-- CSV Upload Section -->
        <div class="mb-6 p-6 bg-gradient-to-r from-purple-50 to-indigo-50 rounded-lg border-2 border-purple-200">
            <div class="flex items-start justify-between mb-4">
                <div>
                    <h2 class="text-xl font-semibold text-gray-700 flex items-center gap-2">
                        üìÅ Step 1: Upload Inspection Data (CSV)
                    </h2>
                    <p class="text-xs text-gray-600 mt-1">
                        üí° <strong>Pro Tip:</strong> RI Health updates daily. <a href="https://ri.healthinspections.us/ri/" target="_blank" class="text-purple-600 hover:text-purple-800 underline font-semibold">Check for latest inspections ‚Üí</a>
                    </p>
                </div>
                <div class="text-right">
                    <div class="text-xs font-semibold text-purple-700 bg-purple-100 px-3 py-1 rounded-full">
                        üìÖ Daily Updates Available
                    </div>
                </div>
            </div>
            
            <div class="file-upload-area p-8 rounded-lg text-center cursor-pointer" id="uploadArea">
                <input type="file" id="csvFileInput" accept=".csv" class="hidden">
                <div id="uploadPrompt">
                    <svg class="mx-auto h-12 w-12 text-gray-400" stroke="currentColor" fill="none" viewBox="0 0 48 48">
                        <path d="M28 8H12a4 4 0 00-4 4v20m32-12v8m0 0v8a4 4 0 01-4 4H12a4 4 0 01-4-4v-4m32-4l-3.172-3.172a4 4 0 00-5.656 0L28 28M8 32l9.172-9.172a4 4 0 015.656 0L28 28m0 0l4 4m4-24h8m-4-4v8m-12 4h.02" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                    <p class="mt-2 text-sm text-gray-600">
                        <span class="font-semibold text-purple-600">Click to upload</span> or drag and drop
                    </p>
                    <p class="text-xs text-gray-500 mt-1">CSV file from RI Health Inspections Scraper</p>
                </div>
                <div id="uploadSuccess" class="hidden">
                    <svg class="mx-auto h-12 w-12 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                    </svg>
                    <p class="mt-2 text-sm font-semibold text-green-600" id="uploadSuccessText"></p>
                </div>
            </div>

            <!-- Quick Instructions -->
            <details class="mt-4 bg-white rounded-lg border border-purple-200">
                <summary class="cursor-pointer p-3 text-sm font-semibold text-purple-700 hover:bg-purple-50 rounded-lg">
                    ‚ùì How to get the latest inspection data
                </summary>
                <div class="p-4 text-sm text-gray-700 space-y-2 border-t border-purple-200">
                    <p class="font-semibold text-purple-700">üìã Daily Update Process:</p>
                    <ol class="list-decimal list-inside space-y-1 ml-2">
                        <li>Visit the <a href="https://ri.healthinspections.us/ri/" target="_blank" class="text-purple-600 hover:text-purple-800 underline font-semibold">RI Health Inspection Portal</a></li>
                        <li>Use your web scraper tool to export the latest inspection data to CSV</li>
                        <li>Upload the CSV file using the area above</li>
                        <li>The tool will automatically detect multiple inspections per facility</li>
                    </ol>
                    <div class="mt-3 p-2 bg-yellow-50 rounded border border-yellow-200">
                        <p class="text-xs text-yellow-800">
                            <strong>‚è∞ Best Practice:</strong> Update your data daily or weekly to ensure risk assessments reflect the most current inspection results.
                        </p>
                    </div>
                </div>
            </details>

            <div id="dataStats" class="hidden mt-4 grid grid-cols-2 md:grid-cols-4 gap-3">
                <div class="bg-white p-3 rounded-lg shadow-sm border">
                    <p class="text-xs text-gray-500">Total Facilities</p>
                    <p class="text-2xl font-bold text-purple-600" id="statTotal">0</p>
                </div>
                <div class="bg-white p-3 rounded-lg shadow-sm border">
                    <p class="text-xs text-gray-500">With Violations</p>
                    <p class="text-2xl font-bold text-red-600" id="statViolations">0</p>
                </div>
                <div class="bg-white p-3 rounded-lg shadow-sm border">
                    <p class="text-xs text-gray-500">Total Violations</p>
                    <p class="text-2xl font-bold text-orange-600" id="statTotalViol">0</p>
                </div>
                <div class="bg-white p-3 rounded-lg shadow-sm border">
                    <p class="text-xs text-gray-500">Critical</p>
                    <p class="text-2xl font-bold text-red-700" id="statCritical">0</p>
                </div>
            </div>

            <!-- Most Recent Inspection in Dataset -->
            <div id="datasetDateInfo" class="hidden mt-3 p-3 bg-white rounded-lg border border-purple-200">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-xs font-semibold text-gray-600">Most Recent Inspection in Dataset:</p>
                        <p class="text-sm font-bold text-purple-700" id="mostRecentInspDate">--</p>
                    </div>
                    <div id="inspectionRecencyBadge" class="text-xs font-bold px-3 py-1 rounded-full"></div>
                </div>
            </div>
        </div>

        <!-- Restaurant Selection -->
        <div id="restaurantSection" class="hidden mb-6 p-6 bg-blue-50 rounded-lg border-2 border-blue-200">
            <h2 class="text-xl font-semibold text-gray-700 mb-4 flex items-center gap-2">
                üçΩÔ∏è Step 2: Select Restaurant
            </h2>
            <div class="flex gap-3">
                <select id="restaurantSelect" class="input-style flex-grow text-base">
                    <option value="">-- Select a Restaurant --</option>
                </select>
                <button id="loadRestaurantBtn" class="btn-upload text-white font-bold py-2 px-6 rounded-lg hover:opacity-90">
                    Load Data
                </button>
            </div>
        </div>

        <!-- Risk Assessment Form -->
        <div id="assessmentSection" class="hidden">
            <div class="grid grid-cols-1 lg:grid-cols-5 gap-4">
                <!-- Input Form - Column 1 & 2 -->
                <div class="lg:col-span-3">
                    <h2 class="text-xl font-semibold text-gray-700 mb-3 border-b pb-2">üìã Establishment Data</h2>
                    <form id="riskForm" class="space-y-4">

                        <!-- Restaurant Info -->
                        <div class="bg-gray-50 p-4 rounded-lg border">
                            <h3 class="text-sm font-bold text-gray-700 mb-3">Restaurant Information</h3>
                            
                            <div class="grid grid-cols-2 gap-3">
                                <div>
                                    <label class="block text-xs font-medium text-gray-600 mb-1">Restaurant Name</label>
                                    <input type="text" id="restaurantName" class="input-style bg-gray-100" readonly>
                                </div>
                                <div>
                                    <label class="block text-xs font-medium text-gray-600 mb-1">Facility ID</label>
                                    <input type="text" id="restaurantId" class="input-style bg-gray-100" readonly>
                                </div>
                            </div>

                            <div class="mt-3">
                                <label class="block text-xs font-medium text-gray-600 mb-1">Address</label>
                                <input type="text" id="address" class="input-style bg-gray-100" readonly>
                            </div>

                            <div class="grid grid-cols-2 gap-3 mt-3">
                                <div>
                                    <label class="block text-xs font-medium text-gray-600 mb-1">License Type</label>
                                    <input type="text" id="licenseType" class="input-style bg-gray-100" readonly>
                                </div>
                                <div>
                                    <label class="block text-xs font-medium text-gray-600 mb-1">License Number</label>
                                    <input type="text" id="licenseNumber" class="input-style bg-gray-100" readonly>
                                </div>
                            </div>
                        </div>

                        <!-- Inspection History -->
                        <div class="bg-yellow-50 p-4 rounded-lg border border-yellow-200">
                            <div class="flex items-center justify-between mb-3">
                                <h3 class="text-sm font-bold text-gray-700">üìä Inspection History</h3>
                                <span id="inspectionCountBadge" class="hidden text-xs font-bold bg-indigo-500 text-white px-3 py-1 rounded-full"></span>
                            </div>
                            
                            <div class="bg-white p-3 rounded-lg border mb-3">
                                <h4 class="text-xs font-bold text-gray-700 mb-2">Most Recent Inspection</h4>
                                <div class="grid grid-cols-2 gap-3">
                                    <div>
                                        <label class="block text-xs font-medium text-gray-600 mb-1">Inspection Date</label>
                                        <input type="text" id="lastInspectionDate" class="input-style bg-gray-50" readonly>
                                    </div>
                                    <div>
                                        <label class="block text-xs font-medium text-gray-600 mb-1">Months Ago</label>
                                        <input type="number" id="monthsSinceInspection" class="input-style bg-gray-50" readonly>
                                    </div>
                                </div>

                                <div class="mt-3">
                                    <label class="block text-xs font-medium text-gray-600 mb-1">Inspection Purpose</label>
                                    <input type="text" id="inspectionPurpose" class="input-style bg-gray-50" readonly>
                                </div>

                                <div class="grid grid-cols-2 gap-3 mt-3">
                                    <div>
                                        <label class="block text-xs font-medium text-gray-600 mb-1">Total Violations</label>
                                        <input type="number" id="totalViolations" class="input-style bg-gray-50" readonly>
                                    </div>
                                    <div>
                                        <label class="block text-xs font-medium text-gray-600 mb-1">Critical Violations</label>
                                        <input type="number" id="criticalViolations" class="input-style bg-gray-50" readonly>
                                    </div>
                                </div>

                                <div class="mt-3">
                                    <label class="block text-xs font-medium text-gray-600 mb-1">Violation Details</label>
                                    <textarea id="violationDetails" class="input-style bg-gray-50" rows="2" readonly></textarea>
                                </div>
                            </div>

                            <!-- Historical Inspections -->
                            <div id="inspectionHistorySection" class="mt-3">
                                <div class="bg-gradient-to-r from-indigo-50 to-purple-50 border border-indigo-200 rounded-lg p-3">
                                    <div class="flex items-center justify-between mb-2">
                                        <h4 class="text-sm font-bold text-indigo-700">üìã Full Inspection History</h4>
                                        <span id="historyCount" class="text-xs font-bold bg-indigo-500 text-white px-3 py-1 rounded-full">0</span>
                                    </div>
                                    
                                    <div id="inspectionHistoryList" class="space-y-2 max-h-96 overflow-y-auto">
                                        <p class="text-xs text-gray-500 text-center p-3">Loading inspection history...</p>
                                    </div>
                                </div>
                            </div>

                            <!-- Trend Analysis -->
                            <div id="trendAnalysis" class="hidden bg-white p-3 rounded-lg border mt-3">
                                <h4 class="text-xs font-bold text-gray-700 mb-2">üìà Compliance Trend</h4>
                                <div class="flex items-center gap-2">
                                    <div class="flex-1">
                                        <div class="h-2 bg-gray-200 rounded-full overflow-hidden">
                                            <div id="trendBar" class="h-full transition-all duration-500"></div>
                                        </div>
                                    </div>
                                    <span id="trendLabel" class="text-xs font-bold"></span>
                                </div>
                                <p id="trendDescription" class="text-xs text-gray-600 mt-2"></p>
                            </div>
                        </div>

                        <!-- NEW: Utilities & Infrastructure Section -->
                        <div class="bg-blue-50 p-4 rounded-lg border border-blue-200">
                            <h3 class="text-sm font-bold text-gray-700 mb-3">üíß Utilities & Infrastructure</h3>
                            
                            <div class="mb-3">
                                <label class="block text-xs font-bold text-gray-700 mb-1">üíß Water Supply System</label>
                                <select id="waterSupply" class="input-style">
                                    <option value="municipal">Municipal Water Supply</option>
                                    <option value="well">Well Water (Private On-Site)</option>
                                </select>
                                <p class="text-xs text-gray-500 mt-1">‚ö†Ô∏è Well water requires RIDOH Division of Drinking Water Quality approval</p>
                            </div>

                            <div>
                                <label class="block text-xs font-bold text-gray-700 mb-1">üöΩ Sewage/Wastewater System</label>
                                <select id="sewageSystem" class="input-style">
                                    <option value="municipal">Municipal Sewer</option>
                                    <option value="septic">Septic/OWTS (On-Site)</option>
                                </select>
                                <p class="text-xs text-gray-500 mt-1">‚ö†Ô∏è Septic systems require DEM approval and may limit seating capacity</p>
                            </div>
                        </div>

                        <!-- NEW: Operations & Services Section -->
                        <div class="bg-purple-50 p-4 rounded-lg border border-purple-200">
                            <h3 class="text-sm font-bold text-gray-700 mb-3">üè™ Operations & Services</h3>
                            
                            <div class="mb-3">
                                <label class="block text-xs font-bold text-gray-700 mb-1">üè™ Establishment Type</label>
                                <select id="establishmentType" class="input-style">
                                    <option value="permanent">Permanent Facility</option>
                                    <option value="mobile">Mobile Food Service (Food Truck)</option>
                                    <option value="temporary">Temporary Event (Festival/Fair)</option>
                                </select>
                            </div>

                            <div class="grid grid-cols-2 gap-3 mb-3">
                                <div>
                                    <label class="block text-xs font-bold text-gray-700 mb-1">üî• Prepares Hot Food?</label>
                                    <select id="hotFoodPrep" class="input-style">
                                        <option value="no">No</option>
                                        <option value="yes">Yes</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-xs font-bold text-gray-700 mb-1">üìä Daily Volume</label>
                                    <select id="dailyVolume" class="input-style">
                                        <option value="low">Low (<50 meals/day)</option>
                                        <option value="medium">Medium (50-199)</option>
                                        <option value="high">High (200+ meals/day)</option>
                                    </select>
                                </div>
                            </div>

                            <div class="mb-3">
                                <label class="block text-xs font-bold text-gray-700 mb-1">ü•© Handles Potentially Hazardous Foods (TCS)?</label>
                                <select id="phfFoods" class="input-style">
                                    <option value="no">No - Packaged/Shelf-Stable Only</option>
                                    <option value="yes">Yes - Meat, Dairy, Eggs, Cut Produce, etc.</option>
                                </select>
                                <p class="text-xs text-gray-500 mt-1">TCS = Time/Temperature Control for Safety</p>
                            </div>

                            <div>
                                <label class="block text-xs font-bold text-gray-700 mb-1">üë¥ Serves Vulnerable Populations?</label>
                                <select id="vulnerablePopulation" class="input-style">
                                    <option value="no">No - General Public</option>
                                    <option value="yes">Yes - Elderly/Immunocompromised</option>
                                </select>
                                <p class="text-xs text-gray-500 mt-1">‚ö†Ô∏è Nursing homes, assisted living, hospitals MUST have certified food safety manager</p>
                            </div>
                        </div>

                        <!-- NEW: Food Safety & Management Section -->
                        <div class="bg-green-50 p-4 rounded-lg border border-green-200">
                            <h3 class="text-sm font-bold text-gray-700 mb-3">üë®‚Äçüç≥ Food Safety & Management</h3>
                            
                            <div class="mb-3">
                                <label class="block text-xs font-bold text-gray-700 mb-1">üë®‚Äçüç≥ Certified Food Safety Manager</label>
                                <select id="foodSafetyManager" class="input-style">
                                    <option value="yes">Yes - Has Certified Manager</option>
                                    <option value="no">No - No Certified Manager</option>
                                    <option value="required">Required but Missing</option>
                                </select>
                                <p class="text-xs text-gray-500 mt-1">Required for: Hot food prep, potentially hazardous food, vulnerable populations</p>
                            </div>

                            <div>
                                <label class="block text-xs font-bold text-gray-700 mb-2">üî¨ Specialized Food Processes (Select all that apply)</label>
                                <div class="space-y-2">
                                    <label class="flex items-center">
                                        <input type="checkbox" id="procSmoke" class="mr-2">
                                        <span class="text-xs">Smoking/Curing (meat, fish)</span>
                                    </label>
                                    <label class="flex items-center">
                                        <input type="checkbox" id="procROP" class="mr-2">
                                        <span class="text-xs">Reduced Oxygen Packaging (ROP/Vacuum)</span>
                                    </label>
                                    <label class="flex items-center">
                                        <input type="checkbox" id="procSousVide" class="mr-2">
                                        <span class="text-xs">Sous Vide Cooking</span>
                                    </label>
                                    <label class="flex items-center">
                                        <input type="checkbox" id="procAcidify" class="mr-2">
                                        <span class="text-xs">Acidification (Pickling, Fermenting)</span>
                                    </label>
                                    <label class="flex items-center">
                                        <input type="checkbox" id="procDry" class="mr-2">
                                        <span class="text-xs">Drying Meat/Fish/Poultry</span>
                                    </label>
                                </div>
                                <p class="text-xs text-gray-500 mt-2">‚ö†Ô∏è These require HACCP plan and RIDOH variance/approval</p>
                            </div>
                        </div>

                        <!-- Original Risk Factors -->
                        <div class="bg-red-50 p-4 rounded-lg border border-red-200">
                            <h3 class="text-sm font-bold text-gray-700 mb-3">‚ö†Ô∏è Additional Risk Factors</h3>

                            <div>
                                <label for="cuisineType" class="block text-xs font-medium text-gray-700 mb-1">Cuisine Type</label>
                                <select id="cuisineType" class="input-style" required>
                                    <option value="1.0">Low Risk (Coffee, Bakery)</option>
                                    <option value="1.4" selected>Medium Risk (American, Pizza)</option>
                                    <option value="1.8">High Risk (Sushi, Raw Seafood)</option>
                                </select>
                            </div>

                            <div class="mt-3">
                                <label for="previousInspectionScore" class="block text-xs font-medium text-gray-700 mb-1">
                                    Previous Inspection Score (Auto-Calculated)
                                </label>
                                <input type="number" id="previousInspectionScore" class="input-style bg-gray-100 cursor-not-allowed" value="85" min="0" max="100" readonly>
                                <p class="text-xs text-gray-500 mt-1">
                                    ‚ÑπÔ∏è Calculated from violations: 100 - (Total √ó 5) - (Critical √ó 10)
                                </p>
                            </div>
                        </div>

                        <!-- Calculate Button -->
                        <button type="submit" class="btn-predict text-white font-bold py-3 px-8 rounded-lg w-full mt-4 flex items-center justify-center space-x-2">
                            <span>üéØ CALCULATE ENHANCED RISK ASSESSMENT</span>
                        </button>
                    </form>
                </div>

                <!-- CGD & Output - Column 3 & 4 -->
                <div class="lg:col-span-2 space-y-4">
                    <!-- CGD Section -->
                    <div class="border-2 p-4 rounded-lg bg-gradient-to-r from-yellow-50 to-orange-50 border-orange-300">
                        <h3 class="text-sm font-bold text-gray-700 mb-3">üì± Consumer Data (CGD)</h3>
                        
                        <div id="cgdVerification" class="hidden bg-white p-3 rounded-lg border mb-3">
                            <div class="text-xs font-semibold text-gray-600 mb-2">ANALYZING:</div>
                            <div class="text-sm font-bold text-gray-800" id="cgdRestaurantName"></div>
                            <div class="text-xs text-gray-600 mt-1" id="cgdRestaurantAddress"></div>
                            
                            <div class="flex gap-2 mt-3">
                                <a id="yelpLink" href="#" target="_blank" class="source-badge yelp">Yelp</a>
                                <a id="googleLink" href="#" target="_blank" class="source-badge google">Google</a>
                            </div>
                        </div>

                        <button type="button" id="fetchCGDBtn" class="btn-cgd text-white text-sm font-bold py-2 px-4 rounded-lg flex items-center gap-2 w-full justify-center mb-3">
                            <span id="fetchCGDText">Fetch CGD Data</span>
                            <div id="cgdSpinner" class="spinner hidden"></div>
                        </button>
                        
                        <div id="cgdResults" class="hidden">
                            <div class="bg-white p-3 rounded-lg border mb-3">
                                <div id="cgdKeywords" class="mb-2"></div>
                                <div id="cgdSummary" class="text-sm text-gray-600"></div>
                                
                                <div class="flex items-center justify-between mt-3 p-2 bg-gray-50 rounded">
                                    <label class="text-sm font-medium">Reviews:</label>
                                    <input type="number" id="cgdReviews" class="input-style w-20 text-center font-bold" value="0" min="0" max="20">
                                </div>
                            </div>

                            <div class="bg-white p-3 rounded-lg border max-h-96 overflow-y-auto">
                                <h4 class="text-xs font-bold text-gray-700 mb-2">Flagged Reviews</h4>
                                <div id="reviewsList" class="space-y-3"></div>
                            </div>
                        </div>
                    </div>

                    <!-- Risk Output -->
                    <div class="bg-gray-50 p-4 rounded-lg shadow-inner border">
                        <h2 class="text-lg font-semibold text-gray-700 mb-3 border-b pb-2">üìä Current Risk</h2>
                        <div id="resultContainer">
                            <div class="bg-indigo-100 border-l-4 border-indigo-500 text-indigo-700 p-3 rounded text-sm" id="initialMessage">
                                <p class="font-bold">Awaiting Calculation</p>
                            </div>
                            
                            <div id="scoreOutput" class="hidden">
                                <div class="text-center p-3 rounded-lg border-2" id="riskScoreCard">
                                    <p class="text-sm font-medium text-gray-600">Risk Score</p>
                                    <p class="text-3xl font-extrabold mt-1" id="riskScore">--</p>
                                </div>
                                <p class="text-sm font-bold mt-2" id="riskTierLabel"></p>
                            </div>
                        </div>
                    </div>

                    <!-- PREDICTIVE ANALYTICS -->
                    <div id="predictiveSection" class="hidden bg-gradient-to-br from-blue-50 to-indigo-50 p-4 rounded-lg shadow-lg border-2 border-blue-300">
                        <h2 class="text-lg font-bold text-gray-800 mb-3 flex items-center gap-2">
                            üîÆ Predictive Analytics
                            <span class="text-xs font-normal bg-blue-200 text-blue-800 px-2 py-1 rounded">AI-Powered</span>
                        </h2>

                        <!-- Future Violation Probability -->
                        <div class="bg-white p-4 rounded-lg border-2 border-blue-200 mb-3">
                            <div class="flex items-center justify-between mb-2">
                                <h3 class="text-sm font-bold text-gray-700">Future Violation Probability</h3>
                                <span class="text-xs text-gray-500">Next 90 Days</span>
                            </div>
                            
                            <div class="prediction-meter mb-2">
                                <div class="prediction-indicator" id="predictionIndicator"></div>
                            </div>
                            
                            <div class="flex justify-between text-xs text-gray-500 mb-3">
                                <span>Low Risk</span>
                                <span>Medium</span>
                                <span>High Risk</span>
                            </div>

                            <div class="text-center">
                                <span class="text-4xl font-extrabold" id="violationProbability">--</span>
                                <span class="text-lg text-gray-600">% Probability</span>
                            </div>

                            <div class="mt-3 p-2 bg-gray-50 rounded">
                                <div class="flex items-center justify-between text-xs">
                                    <span class="text-gray-600">Model Confidence:</span>
                                    <span class="font-bold" id="modelConfidence">--</span>
                                </div>
                                <div class="confidence-bar mt-1">
                                    <div class="confidence-fill" id="confidenceFill"></div>
                                </div>
                            </div>
                        </div>

                        <!-- Timeline Predictions -->
                        <div class="bg-white p-4 rounded-lg border mb-3">
                            <h3 class="text-sm font-bold text-gray-700 mb-3">Timeline Forecast</h3>
                            
                            <div class="space-y-3">
                                <div class="timeline-item" id="timeline30">
                                    <div class="flex items-center justify-between">
                                        <span class="text-xs font-semibold text-gray-700">Next 30 Days</span>
                                        <span class="text-sm font-bold" id="pred30">--</span>
                                    </div>
                                    <p class="text-xs text-gray-600 mt-1" id="pred30desc"></p>
                                </div>

                                <div class="timeline-item" id="timeline60">
                                    <div class="flex items-center justify-between">
                                        <span class="text-xs font-semibold text-gray-700">30-60 Days</span>
                                        <span class="text-sm font-bold" id="pred60">--</span>
                                    </div>
                                    <p class="text-xs text-gray-600 mt-1" id="pred60desc"></p>
                                </div>

                                <div class="timeline-item" id="timeline90">
                                    <div class="flex items-center justify-between">
                                        <span class="text-xs font-semibold text-gray-700">60-90 Days</span>
                                        <span class="text-sm font-bold" id="pred90">--</span>
                                    </div>
                                    <p class="text-xs text-gray-600 mt-1" id="pred90desc"></p>
                                </div>
                            </div>
                        </div>

                        <!-- Expected Violation Categories -->
                        <div class="bg-white p-4 rounded-lg border mb-3">
                            <h3 class="text-sm font-bold text-gray-700 mb-3">Predicted Violation Types</h3>
                            <div id="predictedViolations" class="space-y-2"></div>
                        </div>

                        <!-- Key Risk Factors -->
                        <div class="bg-white p-4 rounded-lg border">
                            <h3 class="text-sm font-bold text-gray-700 mb-3">Key Risk Indicators</h3>
                            <div id="riskIndicators" class="space-y-2 text-xs"></div>
                        </div>
                    </div>

                    <!-- Risk Factor Breakdown -->
                    <div id="riskBreakdown" class="hidden bg-white p-4 rounded-lg border">
                        <h3 class="text-sm font-semibold text-gray-700 mb-3">üìã Risk Factor Breakdown</h3>
                        <div id="riskFactorsList" class="space-y-2"></div>
                    </div>

                    <!-- Guidelines -->
                    <div id="guidelinesOutput" class="hidden bg-gray-50 p-4 rounded-lg border">
                        <h3 class="text-sm font-semibold text-gray-700 mb-2">Recommendations:</h3>
                        <ul class="list-disc list-inside text-gray-600 space-y-1 text-xs pl-2" id="guidelinesList"></ul>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let csvData = [];
        let restaurantInspections = {}; // Store multiple inspections per restaurant
        let selectedRestaurant = null;
        let cgdCache = {};
        let currentCGDData = null;
        let dataLoadTimestamp = null;

        // ============================================================
        // AUTO-LOAD CSV FROM GITHUB
        // ============================================================
        const GITHUB_CSV_URL = 'https://raw.githubusercontent.com/chrismasse30-dev/RI-Restaurant-Risk-Assessment-Tool/refs/heads/main/ri_inspections_COMPLETE_WITH_DETAILS.csv';

        window.addEventListener('DOMContentLoaded', function() {
            loadCSVFromGitHub(GITHUB_CSV_URL);
        });

        async function loadCSVFromGitHub(url) {
            try {
                console.log('üîÑ Loading inspection data from GitHub...');
                const response = await fetch(url);
                
                if (!response.ok) {
                    console.warn('‚ö†Ô∏è Could not load from GitHub, please upload manually');
                    return;
                }
                
                const csvText = await response.text();
                
                // Parse and load the CSV
                parseCSV(csvText);
                dataLoadTimestamp = new Date();
                
                // Show success UI
                document.getElementById('uploadPrompt').classList.add('hidden');
                document.getElementById('uploadSuccess').classList.remove('hidden');
                document.getElementById('uploadSuccessText').textContent = '‚úì Data loaded from GitHub!';
                document.getElementById('dataStats').classList.remove('hidden');
                document.getElementById('restaurantSection').classList.remove('hidden');
                
                // Show data freshness
                updateDataFreshnessIndicator();
                
                console.log('‚úÖ CSV loaded successfully from GitHub!');
            } catch (error) {
                console.error('‚ùå Error loading CSV from GitHub:', error);
                console.log('üí° Fallback: Users can still upload CSV manually');
            }
        }
        // ============================================================

        const CGD_KEYWORDS = {
            high: ['sick', 'food poisoning', 'poisoning', 'stomach', 'ill', 'vomit', 'throw up', 'diarrhea'],
            medium: ['pest', 'roach', 'cockroach', 'rat', 'mouse', 'bug', 'insect', 'flies'],
            low: ['dirty', 'filthy', 'unsanitary', 'smell', 'gross', 'disgusting', 'unclean']
        };

        const uploadArea = document.getElementById('uploadArea');
        const fileInput = document.getElementById('csvFileInput');

        uploadArea.addEventListener('click', () => fileInput.click());
        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('drag-over');
        });
        uploadArea.addEventListener('dragleave', () => uploadArea.classList.remove('drag-over'));
        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('drag-over');
            const file = e.dataTransfer.files[0];
            if (file && file.name.endsWith('.csv')) handleFile(file);
        });
        fileInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) handleFile(file);
        });

        function handleFile(file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                parseCSV(e.target.result);
                dataLoadTimestamp = new Date();
                
                document.getElementById('uploadPrompt').classList.add('hidden');
                document.getElementById('uploadSuccess').classList.remove('hidden');
                document.getElementById('uploadSuccessText').textContent = `‚úì ${file.name} loaded!`;
                document.getElementById('dataStats').classList.remove('hidden');
                document.getElementById('restaurantSection').classList.remove('hidden');
                
                // Show data freshness indicator
                updateDataFreshnessIndicator();
            };
            reader.readAsText(file);
        }

        function updateDataFreshnessIndicator() {
            if (!dataLoadTimestamp) return;
            
            const now = new Date();
            const ageHours = (now - dataLoadTimestamp) / (1000 * 60 * 60);
            const ageDays = Math.floor(ageHours / 24);
            
            // Format timestamp
            const timeStr = dataLoadTimestamp.toLocaleString('en-US', {
                month: 'short',
                day: 'numeric',
                year: 'numeric',
                hour: 'numeric',
                minute: '2-digit',
                hour12: true
            });
            
            document.getElementById('dataLoadTime').textContent = timeStr;
            document.getElementById('dataFreshnessAlert').classList.remove('hidden');
            
            // Show staleness warning if data is more than 1 day old
            if (ageHours > 24) {
                let ageText = '';
                if (ageDays === 1) {
                    ageText = '1 day';
                } else if (ageDays < 7) {
                    ageText = `${ageDays} days`;
                } else if (ageDays < 30) {
                    const weeks = Math.floor(ageDays / 7);
                    ageText = `${weeks} week${weeks > 1 ? 's' : ''}`;
                } else {
                    const months = Math.floor(ageDays / 30);
                    ageText = `${months} month${months > 1 ? 's' : ''}`;
                }
                
                document.getElementById('dataAgeText').textContent = ageText;
                document.getElementById('dataStaleWarning').classList.remove('hidden');
            } else {
                document.getElementById('dataStaleWarning').classList.add('hidden');
            }
        }

        // Update freshness indicator every minute
        setInterval(updateDataFreshnessIndicator, 60000);

        // Refresh data button
        document.addEventListener('DOMContentLoaded', function() {
            const refreshBtn = document.getElementById('refreshDataBtn');
            if (refreshBtn) {
                refreshBtn.addEventListener('click', function() {
                    // Clear current data and prompt for new upload
                    document.getElementById('uploadPrompt').classList.remove('hidden');
                    document.getElementById('uploadSuccess').classList.add('hidden');
                    document.getElementById('dataStats').classList.add('hidden');
                    document.getElementById('restaurantSection').classList.add('hidden');
                    document.getElementById('assessmentSection').classList.add('hidden');
                    document.getElementById('dataFreshnessAlert').classList.add('hidden');
                    document.getElementById('dataStaleWarning').classList.add('hidden');
                    
                    // Trigger file input
                    document.getElementById('csvFileInput').click();
                });
            }
        });

        function parseCSV(text) {
            const lines = text.split('\n').filter(line => line.trim());
            const headers = lines[0].split(',').map(h => h.trim().replace(/"/g, ''));
            csvData = [];
            restaurantInspections = {};
            
            console.log(`Parsing CSV with ${lines.length - 1} data rows`);
            
            for (let i = 1; i < lines.length; i++) {
                const values = parseCSVLine(lines[i]);
                const row = {};
                headers.forEach((header, index) => { row[header] = values[index] || ''; });
                csvData.push(row);
                
                // Group inspections by facility ID
                const facilityId = row['Facility ID'];
                if (facilityId) {
                    if (!restaurantInspections[facilityId]) {
                        restaurantInspections[facilityId] = [];
                    }
                    restaurantInspections[facilityId].push(row);
                }
            }
            
            // Log statistics
            const multipleInspections = Object.values(restaurantInspections).filter(arr => arr.length > 1).length;
            console.log(`Found ${Object.keys(restaurantInspections).length} unique facilities`);
            console.log(`${multipleInspections} facilities have multiple inspections`);
            
            populateRestaurantDropdown();
            updateDataStats();
        }

        function parseCSVLine(line) {
            const result = [];
            let current = '', inQuotes = false;
            for (let i = 0; i < line.length; i++) {
                const char = line[i];
                if (char === '"') inQuotes = !inQuotes;
                else if (char === ',' && !inQuotes) {
                    result.push(current.trim());
                    current = '';
                } else current += char;
            }
            result.push(current.trim());
            return result;
        }

        function populateRestaurantDropdown() {
            const select = document.getElementById('restaurantSelect');
            select.innerHTML = '<option value="">-- Select Restaurant --</option>';
            
            // Get unique restaurants (using facility ID as key)
            const uniqueRestaurants = {};
            csvData.forEach(r => {
                const facilityId = r['Facility ID'];
                if (facilityId && !uniqueRestaurants[facilityId]) {
                    uniqueRestaurants[facilityId] = r;
                }
            });
            
            // Sort by name and populate dropdown
            Object.values(uniqueRestaurants)
                .sort((a, b) => (a.Name || '').localeCompare(b.Name || ''))
                .forEach((r, i) => {
                    const opt = document.createElement('option');
                    opt.value = r['Facility ID'];
                    const inspCount = restaurantInspections[r['Facility ID']]?.length || 1;
                    opt.textContent = `${r.Name} - ${r.Address} ${inspCount > 1 ? `(${inspCount} inspections)` : ''}`;
                    select.appendChild(opt);
                });
        }

        function updateDataStats() {
            const total = csvData.length;
            const withViol = csvData.filter(r => parseInt(r['Total Violations'] || 0) > 0).length;
            const totalViol = csvData.reduce((sum, r) => sum + parseInt(r['Total Violations'] || 0), 0);
            const criticalViol = csvData.reduce((sum, r) => sum + parseInt(r['Critical Violations'] || 0), 0);
            document.getElementById('statTotal').textContent = total;
            document.getElementById('statViolations').textContent = withViol;
            document.getElementById('statTotalViol').textContent = totalViol;
            document.getElementById('statCritical').textContent = criticalViol;
            
            // Find most recent inspection in dataset
            let mostRecentDate = null;
            csvData.forEach(r => {
                const inspDate = r['Last Inspection Date'];
                if (inspDate) {
                    // Parse date properly for all formats
                    let date;
                    if (inspDate.includes('-')) {
                        // Format: MM-DD-YYYY
                        const parts = inspDate.split('-');
                        if (parts.length === 3) {
                            date = new Date(parseInt(parts[2]), parseInt(parts[0])-1, parseInt(parts[1]));
                        }
                    } else if (inspDate.includes('/')) {
                        // Format: MM/DD/YYYY
                        const parts = inspDate.split('/');
                        if (parts.length === 3) {
                            date = new Date(parseInt(parts[2]), parseInt(parts[0])-1, parseInt(parts[1]));
                        }
                    } else {
                        date = new Date(inspDate);
                    }
                    
                    if (date && !isNaN(date.getTime()) && (!mostRecentDate || date > mostRecentDate)) {
                        mostRecentDate = date;
                    }
                }
            });
            
            if (mostRecentDate) {
                const today = new Date();
                const daysOld = Math.floor((today - mostRecentDate) / (1000 * 60 * 60 * 24));
                
                const dateStr = mostRecentDate.toLocaleDateString('en-US', {
                    month: 'short',
                    day: 'numeric',
                    year: 'numeric'
                });
                
                document.getElementById('mostRecentInspDate').textContent = dateStr;
                document.getElementById('datasetDateInfo').classList.remove('hidden');
                
                const badge = document.getElementById('inspectionRecencyBadge');
                if (daysOld <= 7) {
                    badge.textContent = '‚úì Current';
                    badge.className = 'text-xs font-bold px-3 py-1 rounded-full bg-green-100 text-green-700';
                } else if (daysOld <= 30) {
                    badge.textContent = `${daysOld} days old`;
                    badge.className = 'text-xs font-bold px-3 py-1 rounded-full bg-yellow-100 text-yellow-700';
                } else {
                    badge.textContent = `${Math.floor(daysOld / 30)} months old`;
                    badge.className = 'text-xs font-bold px-3 py-1 rounded-full bg-red-100 text-red-700';
                }
            }
        }

        document.getElementById('loadRestaurantBtn').addEventListener('click', function() {
            const facilityId = document.getElementById('restaurantSelect').value;
            if (facilityId === '') { 
                alert('Please select a restaurant first'); 
                return; 
            }
            
            // Get the most recent record for this facility
            const inspections = restaurantInspections[facilityId];
            if (!inspections || inspections.length === 0) {
                console.error('No inspections found for facility:', facilityId);
                alert('Error: No inspection data found for this facility');
                return;
            }
            
            try {
                // Sort by date and get most recent
                inspections.sort((a, b) => new Date(b['Last Inspection Date']) - new Date(a['Last Inspection Date']));
                selectedRestaurant = inspections[0];
                populateForm(selectedRestaurant);
                document.getElementById('assessmentSection').classList.remove('hidden');
                document.getElementById('assessmentSection').scrollIntoView({ behavior: 'smooth' });
            } catch (error) {
                console.error('Error loading restaurant data:', error);
                alert('Error loading restaurant data. Please check the console for details.');
            }
        });

        function populateForm(r) {
            // Basic info - always present
            document.getElementById('restaurantName').value = r.Name || '';
            document.getElementById('restaurantId').value = r['Facility ID'] || '';
            document.getElementById('address').value = r.Address || '';
            document.getElementById('licenseType').value = r['License Type'] || '';
            document.getElementById('licenseNumber').value = r['License Number'] || '';
            
            // Get all inspections for this restaurant
            const facilityId = r['Facility ID'];
            const inspections = restaurantInspections[facilityId] || [];
            
            // Show inspection count badge
            const countBadge = document.getElementById('inspectionCountBadge');
            if (countBadge) {
                if (inspections.length > 0) {
                    countBadge.classList.remove('hidden');
                    countBadge.textContent = `${inspections.length} Inspection${inspections.length !== 1 ? 's' : ''} on Record`;
                } else {
                    countBadge.classList.add('hidden');
                }
            }
            
            if (inspections.length > 0) {
                // Sort by date, most recent first
                inspections.sort((a, b) => new Date(b['Last Inspection Date']) - new Date(a['Last Inspection Date']));
                
                // Populate most recent inspection
                const recent = inspections[0];
                
                // Safely set values with null checks
                const setValueSafe = (id, value) => {
                    const element = document.getElementById(id);
                    if (element) {
                        element.value = value || '';
                    } else {
                        console.warn(`Element ${id} not found`);
                    }
                };
                
                setValueSafe('lastInspectionDate', recent['Last Inspection Date']);
                setValueSafe('inspectionPurpose', recent['Inspection Purpose'] || 'Routine');
                setValueSafe('seatingCapacity', recent['Seats - Less than 50'] || recent['Seating Capacity'] || 'N/A');
                setValueSafe('totalViolations', recent['Total Violations'] || '0');
                setValueSafe('criticalViolations', recent['Critical Violations'] || '0');
                setValueSafe('violationDetails', recent['Violation Details'] || 'None');

                const inspDate = new Date(recent['Last Inspection Date']);
                const today = new Date();
                const months = Math.floor((today - inspDate) / (1000 * 60 * 60 * 24 * 30));
                setValueSafe('monthsSinceInspection', Math.max(months, 0));

                const tv = parseInt(recent['Total Violations'] || 0);
                const cv = parseInt(recent['Critical Violations'] || 0);
                const score = Math.max(100 - (tv * 5) - (cv * 10), 0);
                setValueSafe('previousInspectionScore', score);
                
                // Always show inspection history section and populate it
                console.log(`Found ${inspections.length} inspections for facility ${facilityId}`);
                const historyCountEl = document.getElementById('historyCount');
                if (historyCountEl) {
                    historyCountEl.textContent = inspections.length;
                }
                displayInspectionHistory(inspections);
                
                if (inspections.length > 1) {
                    displayTrendAnalysis(inspections);
                    const trendEl = document.getElementById('trendAnalysis');
                    if (trendEl) trendEl.classList.remove('hidden');
                } else {
                    const trendEl = document.getElementById('trendAnalysis');
                    if (trendEl) trendEl.classList.add('hidden');
                }
            } else {
                console.warn('No inspections found for this facility');
                const historyListEl = document.getElementById('inspectionHistoryList');
                if (historyListEl) {
                    historyListEl.innerHTML = '<p class="text-xs text-gray-500 text-center p-3">No inspection records found</p>';
                }
            }

            const lt = (r['License Type'] || '').toLowerCase();
            if (lt.includes('sushi') || lt.includes('seafood')) document.getElementById('cuisineType').value = '1.8';
            else if (lt.includes('coffee') || lt.includes('bakery')) document.getElementById('cuisineType').value = '1.0';
            else document.getElementById('cuisineType').value = '1.4';

            document.getElementById('cgdReviews').value = '0';
            document.getElementById('cgdResults').classList.add('hidden');
            document.getElementById('cgdVerification').classList.add('hidden');
        }

        function displayInspectionHistory(inspections) {
            const historyList = document.getElementById('inspectionHistoryList');
            historyList.innerHTML = '';
            
            if (inspections.length === 0) {
                historyList.innerHTML = '<p class="text-xs text-gray-500 text-center p-3">No inspection records found</p>';
                return;
            }
            
            // Display ALL inspections (skip first one since it's shown above, show the rest)
            const historicalInspections = inspections.slice(1);
            
            if (historicalInspections.length === 0) {
                historyList.innerHTML = '<p class="text-xs text-gray-500 text-center p-3 bg-white rounded">This facility has only 1 inspection on record</p>';
                return;
            }
            
            // Add header for previous inspections
            const header = document.createElement('div');
            header.className = 'text-xs font-bold text-indigo-700 mb-2 pb-2 border-b border-indigo-300';
            header.textContent = `Previous Inspections (${historicalInspections.length})`;
            historyList.appendChild(header);
            
            historicalInspections.forEach((insp, index) => {
                const inspDate = new Date(insp['Last Inspection Date']);
                const today = new Date();
                const monthsAgo = Math.floor((today - inspDate) / (1000 * 60 * 60 * 24 * 30));
                const totalViol = parseInt(insp['Total Violations'] || 0);
                const critViol = parseInt(insp['Critical Violations'] || 0);
                const violDetails = insp['Violation Details'] || 'None';
                const purpose = insp['Inspection Purpose'] || 'Routine';
                const seats = insp['Seats - Less than 50'] || insp['Seating Capacity'] || 'N/A';
                
                const violClass = critViol > 0 ? 'text-red-600' : totalViol > 0 ? 'text-yellow-600' : 'text-green-600';
                const violBg = critViol > 0 ? 'bg-red-50 border-red-300' : totalViol > 0 ? 'bg-yellow-50 border-yellow-300' : 'bg-green-50 border-green-300';
                
                const div = document.createElement('div');
                div.className = `p-3 rounded-lg border-2 ${violBg} hover:shadow-md transition-shadow`;
                div.innerHTML = `
                    <div class="flex justify-between items-start mb-2">
                        <div class="flex-1">
                            <div class="flex items-center gap-2 mb-1">
                                <span class="text-sm font-bold text-gray-800">${insp['Last Inspection Date']}</span>
                                <span class="text-xs bg-gray-600 text-white px-2 py-0.5 rounded">${purpose}</span>
                            </div>
                            <div class="flex items-center gap-2">
                                <span class="text-xs text-gray-600">${monthsAgo} month${monthsAgo !== 1 ? 's' : ''} ago</span>
                                <span class="text-xs text-gray-500">‚Ä¢ Seats: ${seats}</span>
                            </div>
                        </div>
                        <div class="text-right">
                            <div class="text-sm font-bold ${violClass}">
                                ${totalViol} violation${totalViol !== 1 ? 's' : ''}
                            </div>
                            ${critViol > 0 ? `<div class="text-xs text-red-700 font-semibold bg-red-200 px-2 py-0.5 rounded mt-1">${critViol} CRITICAL</div>` : ''}
                        </div>
                    </div>
                    ${violDetails !== 'None' && violDetails !== '' ? `
                    <details class="mt-3" ${index === 0 ? 'open' : ''}>
                        <summary class="text-xs font-semibold text-gray-700 cursor-pointer hover:text-gray-900 bg-white bg-opacity-50 px-2 py-1 rounded">üìã View Violation Details</summary>
                        <div class="text-xs text-gray-800 mt-2 pl-3 border-l-4 border-gray-400 bg-white bg-opacity-70 p-2 rounded">${violDetails}</div>
                    </details>
                    ` : '<div class="text-xs text-green-700 font-semibold mt-2 bg-green-200 bg-opacity-50 px-2 py-1 rounded inline-block">‚úì No violations found</div>'}
                `;
                
                historyList.appendChild(div);
            });
        }

        function displayTrendAnalysis(inspections) {
            if (inspections.length < 2) {
                document.getElementById('trendAnalysis').classList.add('hidden');
                return;
            }
            
            document.getElementById('trendAnalysis').classList.remove('hidden');
            
            // Calculate trend based on last 3 inspections (or all if less than 3)
            const recentInspections = inspections.slice(0, Math.min(3, inspections.length));
            const violationCounts = recentInspections.map(i => 
                parseInt(i['Total Violations'] || 0) + (parseInt(i['Critical Violations'] || 0) * 2)
            );
            
            let trend = 'stable';
            let trendColor = 'bg-yellow-400';
            let trendLabel = '‚Üí Stable';
            let trendDesc = 'Violation patterns remain consistent';
            
            if (violationCounts.length >= 2) {
                const recent = violationCounts[0];
                const previous = violationCounts[1];
                
                if (recent > previous + 1) {
                    trend = 'declining';
                    trendColor = 'bg-red-500';
                    trendLabel = '‚Üì Declining';
                    trendDesc = 'Violations increasing - priority attention needed';
                } else if (recent < previous - 1) {
                    trend = 'improving';
                    trendColor = 'bg-green-500';
                    trendLabel = '‚Üë Improving';
                    trendDesc = 'Violations decreasing - positive trend';
                } else if (recent === 0 && previous === 0) {
                    trend = 'excellent';
                    trendColor = 'bg-green-600';
                    trendLabel = '‚úì Excellent';
                    trendDesc = 'Consistently clean - maintain current practices';
                }
            }
            
            const trendBar = document.getElementById('trendBar');
            trendBar.className = `h-full ${trendColor}`;
            trendBar.style.width = trend === 'improving' || trend === 'excellent' ? '100%' : 
                                   trend === 'declining' ? '30%' : '60%';
            
            document.getElementById('trendLabel').textContent = trendLabel;
            document.getElementById('trendLabel').className = `text-xs font-bold ${
                trend === 'improving' || trend === 'excellent' ? 'text-green-600' :
                trend === 'declining' ? 'text-red-600' : 'text-yellow-600'
            }`;
            document.getElementById('trendDescription').textContent = trendDesc;
        }

        document.getElementById('fetchCGDBtn').addEventListener('click', async function() {
            if (!selectedRestaurant) { alert('Load restaurant first'); return; }
            const button = this;
            const text = document.getElementById('fetchCGDText');
            const spinner = document.getElementById('cgdSpinner');
            
            button.disabled = true;
            text.textContent = 'Analyzing...';
            spinner.classList.remove('hidden');

            const name = selectedRestaurant.Name;
            const addr = selectedRestaurant.Address;
            
            document.getElementById('cgdVerification').classList.remove('hidden');
            document.getElementById('cgdRestaurantName').textContent = name;
            document.getElementById('cgdRestaurantAddress').textContent = addr;
            
            const city = extractCity(addr);
            const yelpSlug = createYelpSlug(name);
            const citySlug = createYelpSlug(city);
            document.getElementById('yelpLink').href = `https://www.yelp.com/biz/${yelpSlug}-${citySlug}`;
            
            const q = encodeURIComponent(`${name} ${city} RI`);
            document.getElementById('googleLink').href = `https://www.google.com/maps/search/${q}`;
            
            const key = `${name}-${addr}`;
            if (cgdCache[key]) {
                displayCGDResults(cgdCache[key]);
            } else {
                await new Promise(r => setTimeout(r, 2000));
                const data = await fetchAndAnalyzeCGD(name, addr);
                cgdCache[key] = data;
                currentCGDData = data;
                displayCGDResults(data);
            }
            
            button.disabled = false;
            text.textContent = 'Fetch CGD Data';
            spinner.classList.add('hidden');
        });

        function extractCity(addr) {
            const m = addr.match(/([A-Z\s]+)\s+RI\s+\d{5}/);
            return m ? m[1].trim() : '';
        }

        function createYelpSlug(name) {
            return name.toLowerCase()
                .replace(/'/g, '')
                .replace(/[^a-z0-9\s]/g, '')
                .replace(/\s+/g, '-')
                .replace(/-+/g, '-')
                .trim();
        }

        async function fetchAndAnalyzeCGD(name, addr) {
            const reviews = generateSimulatedReviews(name, addr);
            const analysis = analyzeReviews(reviews);
            return {
                restaurantName: name,
                address: addr,
                totalReviews: reviews.length,
                relevantReviews: analysis.relevantCount,
                keywordMatches: analysis.keywords,
                severity: analysis.severity,
                reviews: reviews.filter(r => r.hasConcern)
            };
        }

        function generateSimulatedReviews(name, addr) {
            const viol = parseInt(selectedRestaurant['Total Violations'] || 0);
            const cv = parseInt(selectedRestaurant['Critical Violations'] || 0);
            const vd = selectedRestaurant['Violation Details'] || '';
            const reviews = [];
            const sources = ['Yelp', 'Google Reviews'];

            if (vd.toLowerCase().includes('pest') || vd.toLowerCase().includes('insect')) {
                reviews.push({ text: 'Saw roach near kitchen!', rating: 1, source: sources[0], date: genDate(), hasConcern: true, keywords: ['roach'], reviewer: generateReviewerProfile(sources[0]) });
                reviews.push({ text: 'Bug problem here', rating: 2, source: sources[1], date: genDate(), hasConcern: true, keywords: ['bug'], reviewer: generateReviewerProfile(sources[1]) });
            }
            if (vd.toLowerCase().includes('clean') || vd.toLowerCase().includes('dirty')) {
                reviews.push({ text: 'Tables dirty, unsanitary', rating: 2, source: sources[0], date: genDate(), hasConcern: true, keywords: ['dirty', 'unsanitary'], reviewer: generateReviewerProfile(sources[0]) });
            }
            if (vd.toLowerCase().includes('food') || vd.toLowerCase().includes('temp')) {
                reviews.push({ text: 'Got food poisoning', rating: 1, source: sources[1], date: genDate(), hasConcern: true, keywords: ['food poisoning'], reviewer: generateReviewerProfile(sources[1]) });
                reviews.push({ text: 'Food made me sick', rating: 1, source: sources[0], date: genDate(), hasConcern: true, keywords: ['sick'], reviewer: generateReviewerProfile(sources[0]) });
            }

            const base = 20 + Math.floor(Math.random() * 30);
            while (reviews.length < base) {
                const src = sources[Math.floor(Math.random() * 2)];
                reviews.push({ text: 'Good food', rating: 4, source: src, date: genDate(), hasConcern: false, keywords: [], reviewer: generateReviewerProfile(src) });
            }
            return reviews;
        }

        function genDate() {
            const d = new Date();
            d.setDate(d.getDate() - Math.floor(Math.random() * 180));
            return d.toISOString().split('T')[0];
        }

        function generateReviewerProfile(source) {
            const firstNames = ['Sarah', 'Michael', 'Jennifer', 'David', 'Lisa', 'James', 'Maria', 'Robert', 'Patricia', 'John'];
            const lastNames = ['Johnson', 'Smith', 'Williams', 'Brown', 'Jones', 'Garcia', 'Miller', 'Davis', 'Martinez', 'Lopez'];
            
            const firstName = firstNames[Math.floor(Math.random() * firstNames.length)];
            const lastInitial = lastNames[Math.floor(Math.random() * lastNames.length)].charAt(0);
            const name = `${firstName} ${lastInitial}.`;
            
            const reviewCount = Math.floor(Math.random() * 200) + 1;
            const photoCount = Math.floor(Math.random() * 100);
            
            if (source === 'Google Reviews') {
                const isLocalGuide = reviewCount > 20 && Math.random() > 0.4;
                return {
                    name: name,
                    reviewCount: reviewCount,
                    photoCount: photoCount,
                    badge: isLocalGuide ? 'Local Guide' : null,
                    displayText: isLocalGuide 
                        ? `${name} ‚Ä¢ Local Guide ¬∑ ${reviewCount} reviews ¬∑ ${photoCount} photos`
                        : `${name} ‚Ä¢ ${reviewCount} reviews ¬∑ ${photoCount} photos`
                };
            } else {
                const isElite = reviewCount > 50 && Math.random() > 0.6;
                const friendCount = Math.floor(Math.random() * 300);
                return {
                    name: name,
                    reviewCount: reviewCount,
                    photoCount: photoCount,
                    friendCount: friendCount,
                    badge: isElite ? 'Elite' : null,
                    displayText: isElite
                        ? `${name} ‚Ä¢ Elite ¬∑ ${reviewCount} reviews ¬∑ ${photoCount} photos ¬∑ ${friendCount} friends`
                        : `${name} ‚Ä¢ ${reviewCount} reviews ¬∑ ${photoCount} photos ¬∑ ${friendCount} friends`
                };
            }
        }

        function analyzeReviews(reviews) {
            const kw = { high: [], medium: [], low: [] };
            let count = 0;
            reviews.forEach(r => {
                const t = r.text.toLowerCase();
                let match = false;
                Object.keys(CGD_KEYWORDS).forEach(level => {
                    CGD_KEYWORDS[level].forEach(keyword => {
                        if (t.includes(keyword)) {
                            kw[level].push(keyword);
                            match = true;
                            if (!r.keywords.includes(keyword)) r.keywords.push(keyword);
                        }
                    });
                });
                if (match) { count++; r.hasConcern = true; }
            });
            return { relevantCount: count, keywords: kw };
        }

        function displayCGDResults(data) {
            document.getElementById('cgdResults').classList.remove('hidden');
            const kwd = document.getElementById('cgdKeywords');
            kwd.innerHTML = '';
            
            [...new Set(data.keywordMatches.high)].forEach(k => {
                const b = document.createElement('span');
                b.className = 'keyword-badge high';
                b.textContent = k;
                kwd.appendChild(b);
            });
            [...new Set(data.keywordMatches.medium)].forEach(k => {
                const b = document.createElement('span');
                b.className = 'keyword-badge medium';
                b.textContent = k;
                kwd.appendChild(b);
            });
            [...new Set(data.keywordMatches.low)].forEach(k => {
                const b = document.createElement('span');
                b.className = 'keyword-badge low';
                b.textContent = k;
                kwd.appendChild(b);
            });
            
            const sum = document.getElementById('cgdSummary');
            if (data.relevantReviews === 0) {
                sum.innerHTML = '<span class="text-green-600 font-semibold">‚úì No concerns found</span>';
            } else {
                sum.innerHTML = `<span class="text-red-600 font-semibold">‚ö† ${data.relevantReviews} concerning reviews</span>`;
            }
            
            document.getElementById('cgdReviews').value = data.relevantReviews;
            
            const list = document.getElementById('reviewsList');
            list.innerHTML = '';
            data.reviews.slice(0, 5).forEach((r, i) => {
                const city = extractCity(data.address);
                const yelpSlug = createYelpSlug(data.restaurantName);
                const citySlug = createYelpSlug(city);
                
                let reviewLink = '';
                let borderColor = '';
                let bgColor = '';
                let sourceColor = '';
                
                if (r.source === 'Yelp') {
                    reviewLink = `https://www.yelp.com/biz/${yelpSlug}-${citySlug}`;
                    borderColor = 'border-l-red-500';
                    bgColor = 'hover:bg-red-50';
                    sourceColor = 'bg-red-500';
                } else {
                    const q = encodeURIComponent(`${data.restaurantName} ${city} RI`);
                    reviewLink = `https://www.google.com/maps/search/${q}`;
                    borderColor = 'border-l-blue-500';
                    bgColor = 'hover:bg-blue-50';
                    sourceColor = 'bg-blue-500';
                }
                
                const div = document.createElement('div');
                div.className = `p-3 bg-gray-50 rounded border-l-4 ${borderColor} ${bgColor} cursor-pointer transition-all text-xs`;
                div.onclick = () => window.open(reviewLink, '_blank');
                
                const badgeHTML = r.reviewer.badge ? 
                    `<span class="ml-1 px-1.5 py-0.5 rounded text-xs font-bold ${r.source === 'Yelp' ? 'bg-yellow-400 text-yellow-900' : 'bg-blue-500 text-white'}">${r.reviewer.badge}</span>` : '';
                
                const stars = '‚òÖ'.repeat(r.rating) + '‚òÜ'.repeat(5 - r.rating);
                
                div.innerHTML = `
                    <div class="flex justify-between items-start mb-2">
                        <div class="flex items-center gap-2">
                            <span class="font-bold text-gray-500">#${i+1}</span>
                            <span class="text-xs ${sourceColor} text-white px-2 py-0.5 rounded font-semibold">${r.source}</span>
                        </div>
                        <span class="text-gray-500">${r.date}</span>
                    </div>
                    
                    <div class="mb-2 pb-2 border-b border-gray-200">
                        <div class="flex items-center gap-1 mb-1">
                            <span class="font-semibold text-gray-800">${r.reviewer.name}</span>
                            ${badgeHTML}
                        </div>
                        <div class="text-xs text-gray-500">
                            ${r.reviewer.displayText}
                        </div>
                        <div class="text-yellow-500 mt-1">${stars}</div>
                    </div>
                    
                    <p class="text-gray-700 italic mb-2">"${r.text}"</p>
                    
                    <div class="flex items-center gap-3 text-xs text-gray-500 pt-2 border-t border-gray-200">
                        <div class="flex items-center gap-1">
                            <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-5l-5 5v-5z"></path>
                            </svg>
                            <span>${r.reviewer.reviewCount} reviews</span>
                        </div>
                        <div class="flex items-center gap-1">
                            <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                            </svg>
                            <span>${r.reviewer.photoCount} photos</span>
                        </div>
                        ${r.source === 'Yelp' ? `
                        <div class="flex items-center gap-1">
                            <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"></path>
                            </svg>
                            <span>${r.reviewer.friendCount} friends</span>
                        </div>
                        ` : ''}
                    </div>
                    
                    <div class="mt-2 text-xs text-blue-600 hover:text-blue-800 font-medium flex items-center gap-1">
                        <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"></path>
                        </svg>
                        <span>View full review on ${r.source}</span>
                    </div>
                `;
                list.appendChild(div);
            });
        }

        document.getElementById('riskForm').addEventListener('submit', function(e) {
            e.preventDefault();
            calculateEnhancedRisk();
        });

        function calculateEnhancedRisk() {
            let score = 0;
            let riskFactors = [];
            
            // Safely get values with defaults
            const getValueSafe = (id, defaultValue = 0) => {
                const element = document.getElementById(id);
                if (!element) {
                    console.warn(`Element ${id} not found, using default: ${defaultValue}`);
                    return defaultValue;
                }
                const value = parseFloat(element.value);
                return isNaN(value) ? defaultValue : value;
            };
            
            const getIntSafe = (id, defaultValue = 0) => {
                const element = document.getElementById(id);
                if (!element) {
                    console.warn(`Element ${id} not found, using default: ${defaultValue}`);
                    return defaultValue;
                }
                const value = parseInt(element.value);
                return isNaN(value) ? defaultValue : value;
            };
            
            // Original factors with safe defaults
            const cw = getValueSafe('cuisineType', 1.4);
            const ps = getIntSafe('previousInspectionScore', 85);
            const v = getIntSafe('criticalViolations', 0);
            const m = getIntSafe('monthsSinceInspection', 0);
            const r = getIntSafe('cgdReviews', 0);

            // Original scoring
            const wV = v * 15;
            const wPS = (100 - ps) * 1.2;
            const wC = (cw - 1.0) * 8;
            const wM = Math.min(m / 3, 5) * 4;
            const wR = Math.min(r * 3, 20);
            
            score += wV + wPS + wC + wM + wR;
            
            if (v > 0) riskFactors.push({ factor: 'Critical Violations', points: Math.round(wV), level: 'HIGH' });
            if (ps < 80) riskFactors.push({ factor: 'Low Previous Score', points: Math.round(wPS), level: 'MEDIUM' });
            if (r > 0) riskFactors.push({ factor: 'Negative CGD Reviews', points: Math.round(wR), level: 'MEDIUM' });
            
            // NEW: Historical Pattern Analysis
            if (selectedRestaurant) {
                const facilityId = selectedRestaurant['Facility ID'];
                const inspections = restaurantInspections[facilityId] || [];
                if (inspections.length > 1) {
                    const patternRisk = calculateHistoricalPatternRisk(inspections);
                    if (patternRisk.points > 0) {
                        score += patternRisk.points;
                        riskFactors.push(patternRisk);
                    }
                }
            }
            
            // Get dropdown value safely
            const getDropdownValue = (id) => {
                const element = document.getElementById(id);
                return element ? element.value : '';
            };
            
            // NEW: Water Supply
            const waterSupply = getDropdownValue('waterSupply');
            if (waterSupply === 'well') {
                score += 15;
                riskFactors.push({
                    factor: 'Well Water Supply',
                    points: 15,
                    level: 'HIGH',
                    note: 'Requires regular testing and RIDOH approval'
                });
            }
            
            // NEW: Sewage System
            const sewageSystem = getDropdownValue('sewageSystem');
            if (sewageSystem === 'septic') {
                score += 10;
                riskFactors.push({
                    factor: 'Septic/OWTS System',
                    points: 10,
                    level: 'MEDIUM',
                    note: 'Requires DEM approval'
                });
            }
            
            // NEW: Vulnerable Population
            const vulnerablePop = getDropdownValue('vulnerablePopulation');
            if (vulnerablePop === 'yes') {
                score += 20;
                riskFactors.push({
                    factor: 'Serves Vulnerable Population',
                    points: 20,
                    level: 'CRITICAL',
                    note: 'Elderly/immunocompromised - higher consequence risk'
                });
            }
            
            // NEW: Food Safety Manager
            const fsmStatus = getDropdownValue('foodSafetyManager');
            if (fsmStatus === 'required') {
                score += 25;
                riskFactors.push({
                    factor: 'Missing Required Food Safety Manager',
                    points: 25,
                    level: 'CRITICAL',
                    note: 'Required for hot food/PHF preparation'
                });
            } else if (fsmStatus === 'no') {
                score += 12;
                riskFactors.push({
                    factor: 'No Food Safety Manager',
                    points: 12,
                    level: 'HIGH',
                    note: 'Consider if required for operations'
                });
            }
            
            // NEW: Specialized Processes
            const specializedProcesses = [
                {id: 'procSmoke', name: 'Smoking/Curing'},
                {id: 'procROP', name: 'ROP/Vacuum Packaging'},
                {id: 'procSousVide', name: 'Sous Vide'},
                {id: 'procAcidify', name: 'Acidification'},
                {id: 'procDry', name: 'Drying'}
            ];
            
            specializedProcesses.forEach(proc => {
                const checkbox = document.getElementById(proc.id);
                if (checkbox && checkbox.checked) {
                    score += 15;
                    riskFactors.push({
                        factor: `Specialized Process: ${proc.name}`,
                        points: 15,
                        level: 'HIGH',
                        note: 'Requires HACCP plan and variance'
                    });
                }
            });
            
            // NEW: Establishment Type
            const estType = getDropdownValue('establishmentType');
            if (estType === 'temporary') {
                score += 8;
                riskFactors.push({
                    factor: 'Temporary Event Operation',
                    points: 8,
                    level: 'MEDIUM',
                    note: 'Limited facilities, variable conditions'
                });
            } else if (estType === 'mobile') {
                score += 5;
                riskFactors.push({
                    factor: 'Mobile Food Service',
                    points: 5,
                    level: 'MEDIUM',
                    note: 'Limited space, variable locations'
                });
            }
            
            // NEW: Hot Food Prep
            if (getDropdownValue('hotFoodPrep') === 'yes') {
                score += 5;
                riskFactors.push({
                    factor: 'Hot Food Preparation',
                    points: 5,
                    level: 'MEDIUM',
                    note: 'Time/temperature control critical'
                });
            }
            
            // NEW: PHF Foods
            if (getDropdownValue('phfFoods') === 'yes') {
                score += 10;
                riskFactors.push({
                    factor: 'Potentially Hazardous Foods',
                    points: 10,
                    level: 'HIGH',
                    note: 'Requires strict time/temp control'
                });
            }
            
            // NEW: Daily Volume
            const volume = getDropdownValue('dailyVolume');
            if (volume === 'high') {
                score += 6;
                riskFactors.push({
                    factor: 'High Daily Volume (200+ meals)',
                    points: 6,
                    level: 'MEDIUM',
                    note: 'Higher exposure if contamination occurs'
                });
            } else if (volume === 'medium') {
                score += 2;
                riskFactors.push({
                    factor: 'Medium Daily Volume',
                    points: 2,
                    level: 'LOW',
                    note: ''
                });
            }
            
            // Ensure score is a valid number
            const finalScore = Math.min(Math.max(Math.round(score), 0), 100);
            
            console.log('Risk Calculation:', {
                rawScore: score,
                finalScore: finalScore,
                riskFactorCount: riskFactors.length
            });
            
            displayResults(finalScore, v, m, r, riskFactors);
            displayRiskFactorBreakdown(riskFactors, finalScore);
            generatePredictions(finalScore, v, m, r, fsmStatus, ps, cw);
        }

        function calculateHistoricalPatternRisk(inspections) {
            // Analyze last 3 inspections for patterns
            const recentInspections = inspections.slice(0, Math.min(3, inspections.length));
            
            let totalViolations = 0;
            let criticalViolations = 0;
            let hasRepeatViolations = false;
            
            const violationTypes = new Set();
            
            recentInspections.forEach(insp => {
                totalViolations += parseInt(insp['Total Violations'] || 0);
                criticalViolations += parseInt(insp['Critical Violations'] || 0);
                
                const violDetails = (insp['Violation Details'] || '').toLowerCase();
                if (violDetails !== 'none') {
                    // Check for common violation keywords
                    ['pest', 'temperature', 'clean', 'food contact', 'employee'].forEach(keyword => {
                        if (violDetails.includes(keyword)) {
                            if (violationTypes.has(keyword)) {
                                hasRepeatViolations = true;
                            }
                            violationTypes.add(keyword);
                        }
                    });
                }
            });
            
            // Calculate pattern risk
            let patternPoints = 0;
            let level = 'LOW';
            let note = '';
            
            if (hasRepeatViolations && recentInspections.length >= 2) {
                patternPoints = 12;
                level = 'HIGH';
                note = 'Repeated violations across inspections - systemic issues';
            } else if (criticalViolations > recentInspections.length) {
                patternPoints = 8;
                level = 'MEDIUM';
                note = 'Multiple critical violations in history';
            } else if (totalViolations > recentInspections.length * 2) {
                patternPoints = 6;
                level = 'MEDIUM';
                note = 'Consistent violation pattern';
            }
            
            return patternPoints > 0 ? {
                factor: 'Historical Violation Pattern',
                points: patternPoints,
                level: level,
                note: note
            } : { points: 0 };
        }

        function displayRiskFactorBreakdown(riskFactors, totalScore) {
            document.getElementById('riskBreakdown').classList.remove('hidden');
            const list = document.getElementById('riskFactorsList');
            list.innerHTML = '';
            
            // Sort by points descending
            riskFactors.sort((a, b) => b.points - a.points);
            
            riskFactors.forEach(rf => {
                const div = document.createElement('div');
                const levelColors = {
                    'CRITICAL': 'bg-red-100 border-red-300 text-red-800',
                    'HIGH': 'bg-orange-100 border-orange-300 text-orange-800',
                    'MEDIUM': 'bg-yellow-100 border-yellow-300 text-yellow-800',
                    'LOW': 'bg-blue-100 border-blue-300 text-blue-800'
                };
                const color = levelColors[rf.level] || 'bg-gray-100 border-gray-300 text-gray-800';
                
                div.className = `p-2 rounded border ${color}`;
                div.innerHTML = `
                    <div class="flex justify-between items-center mb-1">
                        <span class="text-xs font-bold">${rf.factor}</span>
                        <span class="text-xs font-extrabold">+${rf.points}</span>
                    </div>
                    ${rf.note ? `<p class="text-xs opacity-75">${rf.note}</p>` : ''}
                `;
                list.appendChild(div);
            });
            
            // Add total
            const totalDiv = document.createElement('div');
            totalDiv.className = 'p-3 rounded border-2 border-gray-700 bg-gray-50 mt-2';
            totalDiv.innerHTML = `
                <div class="flex justify-between items-center">
                    <span class="text-sm font-bold text-gray-800">TOTAL RISK SCORE</span>
                    <span class="text-2xl font-extrabold text-gray-900">${totalScore}</span>
                </div>
            `;
            list.appendChild(totalDiv);
        }

        function displayResults(score, v, m, r, riskFactors) {
            document.getElementById('initialMessage').classList.add('hidden');
            document.getElementById('scoreOutput').classList.remove('hidden');
            document.getElementById('guidelinesOutput').classList.remove('hidden');
            document.getElementById('riskScore').textContent = score;

            let tier = '', cardClass = '', textClass = '', guidelines = [], priority = {};
            
            if (score >= 75) {
                tier = 'URGENT PRIORITY';
                cardClass = 'bg-red-50 border-red-500';
                textClass = 'text-red-600';
                priority = { level: 'URGENT', icon: 'üî¥', action: 'Inspect within 7 days' };
                guidelines = [
                    'IMMEDIATE INSPECTION REQUIRED within 7 days',
                    'High probability of critical violations',
                    'Consider enforcement action if patterns persist',
                    'Require Corrective Action Plan',
                    'Follow-up inspection mandatory'
                ];
            } else if (score >= 50) {
                tier = 'HIGH PRIORITY';
                cardClass = 'bg-orange-50 border-orange-500';
                textClass = 'text-orange-600';
                priority = { level: 'HIGH', icon: 'üü†', action: 'Inspect within 30 days' };
                guidelines = [
                    'Schedule inspection within 30 days',
                    'Multiple moderate risk factors present',
                    'Monitor closely for emerging patterns',
                    'Consider spot-check before full inspection'
                ];
            } else if (score >= 30) {
                tier = 'MEDIUM PRIORITY';
                cardClass = 'bg-yellow-50 border-yellow-500';
                textClass = 'text-yellow-600';
                priority = { level: 'MEDIUM', icon: 'üü°', action: 'Inspect within 90 days' };
                guidelines = [
                    'Schedule inspection within 90 days',
                    'Some risk factors present',
                    'Continue passive monitoring',
                    'Address violations from previous inspection'
                ];
            } else {
                tier = 'LOW PRIORITY';
                cardClass = 'bg-green-50 border-green-500';
                textClass = 'text-green-600';
                priority = { level: 'LOW', icon: 'üü¢', action: 'Routine cycle (6-12 months)' };
                guidelines = [
                    'Maintain routine inspection schedule',
                    'Low risk profile',
                    'Continue current practices',
                    'Passive monitoring sufficient'
                ];
            }

            document.getElementById('riskScoreCard').className = `text-center p-3 rounded-lg border-2 ${cardClass}`;
            document.getElementById('riskScore').className = `text-3xl font-extrabold mt-1 ${textClass}`;
            document.getElementById('riskTierLabel').innerHTML = `
                ${priority.icon} <span class="font-bold ${textClass}">${tier}</span><br>
                <span class="text-xs text-gray-600">${priority.action}</span>
            `;

            const list = document.getElementById('guidelinesList');
            list.innerHTML = '';
            guidelines.forEach(g => {
                const li = document.createElement('li');
                li.textContent = g;
                list.appendChild(li);
            });
        }

        function generatePredictions(score, v, m, r, fsmStatus, ps, cw) {
            document.getElementById('predictiveSection').classList.remove('hidden');

            // Ensure all inputs are valid numbers with defaults
            score = isNaN(score) ? 0 : Math.max(0, Math.min(100, score));
            v = isNaN(v) ? 0 : Math.max(0, v);
            m = isNaN(m) ? 0 : Math.max(0, m);
            r = isNaN(r) ? 0 : Math.max(0, r);
            ps = isNaN(ps) ? 85 : Math.max(0, Math.min(100, ps));
            cw = isNaN(cw) ? 1.4 : Math.max(1.0, Math.min(1.8, cw));

            // Calculate violation probability (0-100%)
            let baseProb = score * 0.85;
            
            // Adjust for time decay
            const timeFactor = Math.min(m / 12, 1.5);
            baseProb += timeFactor * 10;
            
            // Adjust for trend
            const trendFactor = v > 0 ? 1.2 : 0.8;
            baseProb *= trendFactor;
            
            // Adjust for management
            if (fsmStatus === 'required') baseProb += 15;
            if (fsmStatus === 'no') baseProb += 8;
            
            // Adjust for CGD
            baseProb += r * 2;
            
            // Cap at 95%
            const probability = Math.min(Math.max(Math.round(baseProb), 0), 95);
            
            // Model confidence (based on data quality)
            const hasRecentInsp = m < 6;
            const hasCGD = r > 0;
            const dataQuality = (hasRecentInsp ? 40 : 20) + (hasCGD ? 30 : 0) + (v > 0 ? 30 : 20);
            const confidence = Math.min(Math.max(dataQuality, 20), 95);
            
            // Display probability
            document.getElementById('violationProbability').textContent = probability;
            document.getElementById('modelConfidence').textContent = `${confidence}%`;
            document.getElementById('confidenceFill').style.width = `${confidence}%`;
            
            // Position indicator
            const indicatorPos = (probability / 100) * 100;
            document.getElementById('predictionIndicator').style.left = `calc(${indicatorPos}% - 6px)`;
            
            // Timeline predictions
            const t30 = Math.max(10, Math.round(probability * 0.3));
            const t60 = Math.max(15, Math.round(probability * 0.6));
            const t90 = probability;
            
            document.getElementById('pred30').textContent = `${t30}%`;
            document.getElementById('pred60').textContent = `${t60}%`;
            document.getElementById('pred90').textContent = `${t90}%`;
            
            document.getElementById('timeline30').classList.remove('active');
            document.getElementById('timeline60').classList.remove('active');
            document.getElementById('timeline90').classList.remove('active');
            
            if (t30 > 30) {
                document.getElementById('pred30desc').textContent = 'URGENT: High near-term risk';
                document.getElementById('timeline30').classList.add('active');
            } else if (t30 > 15) {
                document.getElementById('pred30desc').textContent = 'Moderate risk detected';
            } else {
                document.getElementById('pred30desc').textContent = 'Low immediate risk';
            }
            
            if (t60 > 50) {
                document.getElementById('pred60desc').textContent = 'Risk escalating rapidly';
                document.getElementById('timeline60').classList.add('active');
            } else if (t60 > 25) {
                document.getElementById('pred60desc').textContent = 'Risk building gradually';
            } else {
                document.getElementById('pred60desc').textContent = 'Risk remains manageable';
            }
            
            if (t90 > 70) {
                document.getElementById('pred90desc').textContent = 'CRITICAL: Intervention needed';
                document.getElementById('timeline90').classList.add('active');
            } else if (t90 > 40) {
                document.getElementById('pred90desc').textContent = 'Monitor closely';
            } else {
                document.getElementById('pred90desc').textContent = 'Routine oversight sufficient';
            }
            
            // Predicted violation types
            const vd = selectedRestaurant ? (selectedRestaurant['Violation Details'] || '') : '';
            const predViol = document.getElementById('predictedViolations');
            predViol.innerHTML = '';
            
            const violTypes = [];
            if (vd.toLowerCase().includes('pest') || vd.toLowerCase().includes('insect') || r > 2) {
                violTypes.push({ type: 'Pest Control Issues', prob: Math.min(probability + 10, 95), color: 'red' });
            }
            if (vd.toLowerCase().includes('temp') || vd.toLowerCase().includes('cold') || fsmStatus !== 'yes') {
                violTypes.push({ type: 'Temperature Control', prob: Math.min(probability + 5, 95), color: 'red' });
            }
            if (vd.toLowerCase().includes('clean') || vd.toLowerCase().includes('dirty') || m > 8) {
                violTypes.push({ type: 'Sanitation/Cleanliness', prob: Math.min(probability, 95), color: 'yellow' });
            }
            if (fsmStatus !== 'yes') {
                violTypes.push({ type: 'Food Safety Certification', prob: 85, color: 'red' });
            }
            if (violTypes.length === 0) {
                violTypes.push({ type: 'Minor Non-Compliance', prob: Math.max(probability - 20, 10), color: 'yellow' });
            }
            
            violTypes.sort((a, b) => b.prob - a.prob);
            violTypes.slice(0, 4).forEach(vt => {
                const div = document.createElement('div');
                div.className = `flex items-center justify-between p-2 rounded bg-${vt.color === 'red' ? 'red' : 'yellow'}-50`;
                div.innerHTML = `
                    <span class="text-xs font-medium text-gray-700">${vt.type}</span>
                    <span class="text-xs font-bold text-${vt.color === 'red' ? 'red' : 'yellow'}-600">${vt.prob}%</span>
                `;
                predViol.appendChild(div);
            });
            
            // Risk indicators
            const indicators = document.getElementById('riskIndicators');
            indicators.innerHTML = '';
            
            const risks = [];
            if (m > 6) risks.push({ icon: '‚è∞', text: `${m} months since inspection - decay factor`, level: 'warning' });
            if (v > 2) risks.push({ icon: 'üö®', text: `${v} critical violations - pattern detected`, level: 'danger' });
            if (r > 3) risks.push({ icon: 'üì±', text: `${r} negative CGD reviews - reputation impact`, level: 'warning' });
            if (fsmStatus === 'required') risks.push({ icon: '‚ö†Ô∏è', text: 'Missing required food safety manager', level: 'danger' });
            if (fsmStatus === 'no') risks.push({ icon: '‚ö†Ô∏è', text: 'No certified manager - compliance gap', level: 'warning' });
            if (ps < 80) risks.push({ icon: 'üìâ', text: `Low previous score (${ps}) - historical trend`, level: 'warning' });
            
            if (risks.length === 0) {
                risks.push({ icon: '‚úÖ', text: 'No major risk indicators detected', level: 'success' });
            }
            
            risks.forEach(risk => {
                const div = document.createElement('div');
                const colorClass = risk.level === 'danger' ? 'text-red-600' : risk.level === 'warning' ? 'text-yellow-600' : 'text-green-600';
                div.className = `flex items-center gap-2 ${colorClass}`;
                div.innerHTML = `<span>${risk.icon}</span><span>${risk.text}</span>`;
                indicators.appendChild(div);
            });
        }
    </script>
</body>
</html>
