<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RI Restaurant Risk Assessment Tool - Predictive Analytics</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f9fb;
        }
        .btn-predict {
            background-image: linear-gradient(to right, #10b981, #059669);
            transition: all 0.2s ease-in-out;
            box-shadow: 0 4px 6px -1px rgba(16, 185, 129, 0.4), 0 2px 4px -2px rgba(16, 185, 129, 0.4);
        }
        .btn-predict:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 15px -3px rgba(16, 185, 129, 0.3), 0 4px 6px -4px rgba(16, 185, 129, 0.3);
        }
        .btn-upload {
            background-image: linear-gradient(to right, #667eea, #764ba2);
            transition: all 0.2s ease-in-out;
        }
        .btn-upload:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 15px -3px rgba(102, 126, 234, 0.3);
        }
        .btn-cgd {
            background-image: linear-gradient(to right, #f59e0b, #d97706);
            transition: all 0.2s ease-in-out;
        }
        .btn-cgd:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 15px -3px rgba(245, 158, 11, 0.3);
        }
        .input-style {
            padding: 0.5rem;
            border: 1px solid #e5e7eb;
            border-radius: 0.5rem;
            width: 100%;
            background-color: white;
            transition: border-color 0.2s;
        }
        .input-style:focus {
            border-color: #10b981;
            outline: none;
        }
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-top: 4px solid #10b981;
            border-radius: 50%;
            width: 1.5rem;
            height: 1.5rem;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .file-upload-area {
            border: 2px dashed #cbd5e0;
            transition: all 0.3s;
        }
        .file-upload-area:hover {
            border-color: #667eea;
            background-color: #f7fafc;
        }
        .file-upload-area.drag-over {
            border-color: #667eea;
            background-color: #eef2ff;
        }
        .keyword-badge {
            display: inline-block;
            padding: 0.25rem 0.5rem;
            margin: 0.25rem;
            border-radius: 0.25rem;
            font-size: 0.75rem;
            font-weight: 600;
        }
        .keyword-badge.high { background-color: #fee2e2; color: #991b1b; }
        .keyword-badge.medium { background-color: #fef3c7; color: #92400e; }
        .keyword-badge.low { background-color: #dbeafe; color: #1e40af; }
        .review-card {
            border-left: 4px solid #e5e7eb;
            transition: all 0.2s;
        }
        .review-card:hover {
            border-left-color: #f59e0b;
            background-color: #fffbeb;
        }
        .source-badge {
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
            padding: 0.25rem 0.5rem;
            border-radius: 0.375rem;
            font-size: 0.75rem;
            font-weight: 600;
            text-decoration: none;
            transition: all 0.2s;
        }
        .source-badge.yelp {
            background-color: #d32323;
            color: white;
        }
        .source-badge.yelp:hover {
            background-color: #b51e1e;
        }
        .source-badge.google {
            background-color: #4285f4;
            color: white;
        }
        .source-badge.google:hover {
            background-color: #3367d6;
        }
        .prediction-meter {
            height: 12px;
            background: linear-gradient(to right, #10b981, #f59e0b, #ef4444);
            border-radius: 6px;
            position: relative;
        }
        .prediction-indicator {
            position: absolute;
            top: -8px;
            width: 0;
            height: 0;
            border-left: 6px solid transparent;
            border-right: 6px solid transparent;
            border-top: 8px solid #1f2937;
            transition: left 0.5s ease;
        }
        .timeline-item {
            border-left: 3px solid #e5e7eb;
            padding-left: 1rem;
            margin-left: 0.5rem;
        }
        .timeline-item.active {
            border-left-color: #3b82f6;
        }
        .confidence-bar {
            height: 8px;
            background-color: #e5e7eb;
            border-radius: 4px;
            overflow: hidden;
        }
        .confidence-fill {
            height: 100%;
            background: linear-gradient(to right, #10b981, #059669);
            transition: width 0.5s ease;
        }
    </style>
</head>
<body class="p-4 md:p-8">
    <div class="max-w-7xl mx-auto bg-white shadow-xl rounded-xl p-4 md:p-6">

        <!-- Header -->
        <header class="text-center mb-6">
            <h1 class="text-3xl md:text-4xl font-extrabold text-gray-800">üè• RI Restaurant Risk Assessment Tool</h1>
            <p class="text-gray-500 mt-1 text-base">Predictive Analytics & Consumer Feedback Analysis</p>
        </header>

        <!-- CSV Upload Section -->
        <div class="mb-6 p-6 bg-gradient-to-r from-purple-50 to-indigo-50 rounded-lg border-2 border-purple-200">
            <h2 class="text-xl font-semibold text-gray-700 mb-4 flex items-center gap-2">
                üìÅ Step 1: Upload Inspection Data (CSV)
            </h2>
            
            <div class="file-upload-area p-8 rounded-lg text-center cursor-pointer" id="uploadArea">
                <input type="file" id="csvFileInput" accept=".csv" class="hidden">
                <div id="uploadPrompt">
                    <svg class="mx-auto h-12 w-12 text-gray-400" stroke="currentColor" fill="none" viewBox="0 0 48 48">
                        <path d="M28 8H12a4 4 0 00-4 4v20m32-12v8m0 0v8a4 4 0 01-4 4H12a4 4 0 01-4-4v-4m32-4l-3.172-3.172a4 4 0 00-5.656 0L28 28M8 32l9.172-9.172a4 4 0 015.656 0L28 28m0 0l4 4m4-24h8m-4-4v8m-12 4h.02" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                    <p class="mt-2 text-sm text-gray-600">
                        <span class="font-semibold text-purple-600">Click to upload</span> or drag and drop
                    </p>
                    <p class="text-xs text-gray-500 mt-1">CSV file from RI Health Inspections Scraper</p>
                </div>
                <div id="uploadSuccess" class="hidden">
                    <svg class="mx-auto h-12 w-12 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                    </svg>
                    <p class="mt-2 text-sm font-semibold text-green-600" id="uploadSuccessText"></p>
                </div>
            </div>

            <div id="dataStats" class="hidden mt-4 grid grid-cols-2 md:grid-cols-4 gap-3">
                <div class="bg-white p-3 rounded-lg shadow-sm border">
                    <p class="text-xs text-gray-500">Total Facilities</p>
                    <p class="text-2xl font-bold text-purple-600" id="statTotal">0</p>
                </div>
                <div class="bg-white p-3 rounded-lg shadow-sm border">
                    <p class="text-xs text-gray-500">With Violations</p>
                    <p class="text-2xl font-bold text-red-600" id="statViolations">0</p>
                </div>
                <div class="bg-white p-3 rounded-lg shadow-sm border">
                    <p class="text-xs text-gray-500">Total Violations</p>
                    <p class="text-2xl font-bold text-orange-600" id="statTotalViol">0</p>
                </div>
                <div class="bg-white p-3 rounded-lg shadow-sm border">
                    <p class="text-xs text-gray-500">Critical</p>
                    <p class="text-2xl font-bold text-red-700" id="statCritical">0</p>
                </div>
            </div>
        </div>

        <!-- Restaurant Selection -->
        <div id="restaurantSection" class="hidden mb-6 p-6 bg-blue-50 rounded-lg border-2 border-blue-200">
            <h2 class="text-xl font-semibold text-gray-700 mb-4 flex items-center gap-2">
                üçΩÔ∏è Step 2: Select Restaurant
            </h2>
            <div class="flex gap-3">
                <select id="restaurantSelect" class="input-style flex-grow text-base">
                    <option value="">-- Select a Restaurant --</option>
                </select>
                <button id="loadRestaurantBtn" class="btn-upload text-white font-bold py-2 px-6 rounded-lg hover:opacity-90">
                    Load Data
                </button>
            </div>
        </div>

        <!-- Risk Assessment Form -->
        <div id="assessmentSection" class="hidden">
            <div class="grid grid-cols-1 lg:grid-cols-5 gap-4">
                <!-- Input Form - Column 1 & 2 -->
                <div class="lg:col-span-3">
                    <h2 class="text-xl font-semibold text-gray-700 mb-3 border-b pb-2">üìã Establishment Data</h2>
                    <form id="riskForm" class="space-y-4">

                        <!-- Restaurant Info -->
                        <div class="bg-gray-50 p-4 rounded-lg border">
                            <h3 class="text-sm font-bold text-gray-700 mb-3">Restaurant Information</h3>
                            
                            <div class="grid grid-cols-2 gap-3">
                                <div>
                                    <label class="block text-xs font-medium text-gray-600 mb-1">Restaurant Name</label>
                                    <input type="text" id="restaurantName" class="input-style bg-gray-100" readonly>
                                </div>
                                <div>
                                    <label class="block text-xs font-medium text-gray-600 mb-1">Facility ID</label>
                                    <input type="text" id="restaurantId" class="input-style bg-gray-100" readonly>
                                </div>
                            </div>

                            <div class="mt-3">
                                <label class="block text-xs font-medium text-gray-600 mb-1">Address</label>
                                <input type="text" id="address" class="input-style bg-gray-100" readonly>
                            </div>

                            <div class="grid grid-cols-2 gap-3 mt-3">
                                <div>
                                    <label class="block text-xs font-medium text-gray-600 mb-1">License Type</label>
                                    <input type="text" id="licenseType" class="input-style bg-gray-100" readonly>
                                </div>
                                <div>
                                    <label class="block text-xs font-medium text-gray-600 mb-1">License Number</label>
                                    <input type="text" id="licenseNumber" class="input-style bg-gray-100" readonly>
                                </div>
                            </div>
                        </div>

                        <!-- Inspection Data -->
                        <div class="bg-yellow-50 p-4 rounded-lg border border-yellow-200">
                            <h3 class="text-sm font-bold text-gray-700 mb-3">üìä Inspection History</h3>
                            
                            <div class="grid grid-cols-2 gap-3">
                                <div>
                                    <label class="block text-xs font-medium text-gray-600 mb-1">Last Inspection Date</label>
                                    <input type="text" id="lastInspectionDate" class="input-style bg-white" readonly>
                                </div>
                                <div>
                                    <label class="block text-xs font-medium text-gray-600 mb-1">Months Since Inspection</label>
                                    <input type="number" id="monthsSinceInspection" class="input-style bg-white" readonly>
                                </div>
                            </div>

                            <div class="grid grid-cols-2 gap-3 mt-3">
                                <div>
                                    <label class="block text-xs font-medium text-gray-600 mb-1">Total Violations</label>
                                    <input type="number" id="totalViolations" class="input-style bg-white" readonly>
                                </div>
                                <div>
                                    <label class="block text-xs font-medium text-gray-600 mb-1">Critical Violations</label>
                                    <input type="number" id="criticalViolations" class="input-style bg-white" readonly>
                                </div>
                            </div>

                            <div class="mt-3">
                                <label class="block text-xs font-medium text-gray-600 mb-1">Violation Details</label>
                                <textarea id="violationDetails" class="input-style bg-white" rows="2" readonly></textarea>
                            </div>
                        </div>

                        <!-- Risk Factors -->
                        <div class="bg-red-50 p-4 rounded-lg border border-red-200">
                            <h3 class="text-sm font-bold text-gray-700 mb-3">‚ö†Ô∏è Risk Factors</h3>

                            <div>
                                <label for="cuisineType" class="block text-sm font-medium text-gray-700 mb-1">Cuisine Type</label>
                                <select id="cuisineType" class="input-style" required>
                                    <option value="1.0">Low Risk (Coffee, Bakery)</option>
                                    <option value="1.4" selected>Medium Risk (American, Pizza)</option>
                                    <option value="1.8">High Risk (Sushi, Raw Seafood)</option>
                                </select>
                            </div>

                            <div class="mt-3">
                                <label for="previousInspectionScore" class="block text-sm font-medium text-gray-700 mb-1">Previous Score (0-100)</label>
                                <input type="number" id="previousInspectionScore" class="input-style" value="85" min="0" max="100" required>
                            </div>

                            <div class="mt-3 flex items-center justify-between p-3 border rounded-lg bg-white">
                                <label for="specializedProcess" class="text-sm font-medium text-gray-700">Specialized Processes?</label>
                                <select id="specializedProcess" class="input-style w-40">
                                    <option value="0" selected>No</option>
                                    <option value="1">Yes (HACCP)</option>
                                </select>
                            </div>

                            <div class="mt-3">
                                <label for="certifiedManager" class="block text-sm font-medium text-gray-700 mb-1">Certified Manager</label>
                                <select id="certifiedManager" class="input-style" required>
                                    <option value="0" selected>On Site</option>
                                    <option value="1">No Manager</option>
                                </select>
                            </div>
                        </div>

                        <!-- Calculate Button -->
                        <button type="submit" class="btn-predict text-white font-bold py-3 px-8 rounded-lg w-full mt-4 flex items-center justify-center space-x-2">
                            <span>üéØ CALCULATE PREDICTIVE RISK</span>
                        </button>
                    </form>
                </div>

                <!-- CGD & Output - Column 3 & 4 -->
                <div class="lg:col-span-2 space-y-4">
                    <!-- CGD Section -->
                    <div class="border-2 p-4 rounded-lg bg-gradient-to-r from-yellow-50 to-orange-50 border-orange-300">
                        <h3 class="text-sm font-bold text-gray-700 mb-3">üì± Consumer Data (CGD)</h3>
                        
                        <div id="cgdVerification" class="hidden bg-white p-3 rounded-lg border mb-3">
                            <div class="text-xs font-semibold text-gray-600 mb-2">ANALYZING:</div>
                            <div class="text-sm font-bold text-gray-800" id="cgdRestaurantName"></div>
                            <div class="text-xs text-gray-600 mt-1" id="cgdRestaurantAddress"></div>
                            
                            <div class="flex gap-2 mt-3">
                                <a id="yelpLink" href="#" target="_blank" class="source-badge yelp">Yelp</a>
                                <a id="googleLink" href="#" target="_blank" class="source-badge google">Google</a>
                            </div>
                        </div>

                        <button type="button" id="fetchCGDBtn" class="btn-cgd text-white text-sm font-bold py-2 px-4 rounded-lg flex items-center gap-2 w-full justify-center mb-3">
                            <span id="fetchCGDText">Fetch CGD Data</span>
                            <div id="cgdSpinner" class="spinner hidden"></div>
                        </button>
                        
                        <div id="cgdResults" class="hidden">
                            <div class="bg-white p-3 rounded-lg border mb-3">
                                <div id="cgdKeywords" class="mb-2"></div>
                                <div id="cgdSummary" class="text-sm text-gray-600"></div>
                                
                                <div class="flex items-center justify-between mt-3 p-2 bg-gray-50 rounded">
                                    <label class="text-sm font-medium">Reviews:</label>
                                    <input type="number" id="cgdReviews" class="input-style w-20 text-center font-bold" value="0" min="0" max="20">
                                </div>
                            </div>

                            <div class="bg-white p-3 rounded-lg border max-h-64 overflow-y-auto">
                                <h4 class="text-xs font-bold text-gray-700 mb-2">Flagged Reviews</h4>
                                <div id="reviewsList" class="space-y-2"></div>
                            </div>
                        </div>
                    </div>

                    <!-- Risk Output -->
                    <div class="bg-gray-50 p-4 rounded-lg shadow-inner border">
                        <h2 class="text-lg font-semibold text-gray-700 mb-3 border-b pb-2">üìä Current Risk</h2>
                        <div id="resultContainer">
                            <div class="bg-indigo-100 border-l-4 border-indigo-500 text-indigo-700 p-3 rounded text-sm" id="initialMessage">
                                <p class="font-bold">Awaiting Calculation</p>
                            </div>
                            
                            <div id="scoreOutput" class="hidden">
                                <div class="text-center p-3 rounded-lg border-2" id="riskScoreCard">
                                    <p class="text-sm font-medium text-gray-600">Risk Score</p>
                                    <p class="text-3xl font-extrabold mt-1" id="riskScore">--</p>
                                </div>
                                <p class="text-sm font-bold mt-2" id="riskTierLabel"></p>
                            </div>
                        </div>
                    </div>

                    <!-- PREDICTIVE ANALYTICS -->
                    <div id="predictiveSection" class="hidden bg-gradient-to-br from-blue-50 to-indigo-50 p-4 rounded-lg shadow-lg border-2 border-blue-300">
                        <h2 class="text-lg font-bold text-gray-800 mb-3 flex items-center gap-2">
                            üîÆ Predictive Analytics
                            <span class="text-xs font-normal bg-blue-200 text-blue-800 px-2 py-1 rounded">AI-Powered</span>
                        </h2>

                        <!-- Future Violation Probability -->
                        <div class="bg-white p-4 rounded-lg border-2 border-blue-200 mb-3">
                            <div class="flex items-center justify-between mb-2">
                                <h3 class="text-sm font-bold text-gray-700">Future Violation Probability</h3>
                                <span class="text-xs text-gray-500">Next 90 Days</span>
                            </div>
                            
                            <div class="prediction-meter mb-2">
                                <div class="prediction-indicator" id="predictionIndicator"></div>
                            </div>
                            
                            <div class="flex justify-between text-xs text-gray-500 mb-3">
                                <span>Low Risk</span>
                                <span>Medium</span>
                                <span>High Risk</span>
                            </div>

                            <div class="text-center">
                                <span class="text-4xl font-extrabold" id="violationProbability">--</span>
                                <span class="text-lg text-gray-600">% Probability</span>
                            </div>

                            <div class="mt-3 p-2 bg-gray-50 rounded">
                                <div class="flex items-center justify-between text-xs">
                                    <span class="text-gray-600">Model Confidence:</span>
                                    <span class="font-bold" id="modelConfidence">--</span>
                                </div>
                                <div class="confidence-bar mt-1">
                                    <div class="confidence-fill" id="confidenceFill"></div>
                                </div>
                            </div>
                        </div>

                        <!-- Timeline Predictions -->
                        <div class="bg-white p-4 rounded-lg border mb-3">
                            <h3 class="text-sm font-bold text-gray-700 mb-3">Timeline Forecast</h3>
                            
                            <div class="space-y-3">
                                <div class="timeline-item" id="timeline30">
                                    <div class="flex items-center justify-between">
                                        <span class="text-xs font-semibold text-gray-700">Next 30 Days</span>
                                        <span class="text-sm font-bold" id="pred30">--</span>
                                    </div>
                                    <p class="text-xs text-gray-600 mt-1" id="pred30desc"></p>
                                </div>

                                <div class="timeline-item" id="timeline60">
                                    <div class="flex items-center justify-between">
                                        <span class="text-xs font-semibold text-gray-700">30-60 Days</span>
                                        <span class="text-sm font-bold" id="pred60">--</span>
                                    </div>
                                    <p class="text-xs text-gray-600 mt-1" id="pred60desc"></p>
                                </div>

                                <div class="timeline-item" id="timeline90">
                                    <div class="flex items-center justify-between">
                                        <span class="text-xs font-semibold text-gray-700">60-90 Days</span>
                                        <span class="text-sm font-bold" id="pred90">--</span>
                                    </div>
                                    <p class="text-xs text-gray-600 mt-1" id="pred90desc"></p>
                                </div>
                            </div>
                        </div>

                        <!-- Expected Violation Categories -->
                        <div class="bg-white p-4 rounded-lg border mb-3">
                            <h3 class="text-sm font-bold text-gray-700 mb-3">Predicted Violation Types</h3>
                            <div id="predictedViolations" class="space-y-2"></div>
                        </div>

                        <!-- Key Risk Factors -->
                        <div class="bg-white p-4 rounded-lg border">
                            <h3 class="text-sm font-bold text-gray-700 mb-3">Key Risk Indicators</h3>
                            <div id="riskIndicators" class="space-y-2 text-xs"></div>
                        </div>
                    </div>

                    <!-- Guidelines -->
                    <div id="guidelinesOutput" class="hidden bg-gray-50 p-4 rounded-lg border">
                        <h3 class="text-sm font-semibold text-gray-700 mb-2">Recommendations:</h3>
                        <ul class="list-disc list-inside text-gray-600 space-y-1 text-xs pl-2" id="guidelinesList"></ul>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let csvData = [];
        let selectedRestaurant = null;
        let cgdCache = {};
        let currentCGDData = null;

        const CGD_KEYWORDS = {
            high: ['sick', 'food poisoning', 'poisoning', 'stomach', 'ill', 'vomit', 'throw up', 'diarrhea'],
            medium: ['pest', 'roach', 'cockroach', 'rat', 'mouse', 'bug', 'insect', 'flies'],
            low: ['dirty', 'filthy', 'unsanitary', 'smell', 'gross', 'disgusting', 'unclean']
        };

        const uploadArea = document.getElementById('uploadArea');
        const fileInput = document.getElementById('csvFileInput');

        uploadArea.addEventListener('click', () => fileInput.click());
        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('drag-over');
        });
        uploadArea.addEventListener('dragleave', () => uploadArea.classList.remove('drag-over'));
        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('drag-over');
            const file = e.dataTransfer.files[0];
            if (file && file.name.endsWith('.csv')) handleFile(file);
        });
        fileInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) handleFile(file);
        });

        function handleFile(file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                parseCSV(e.target.result);
                document.getElementById('uploadPrompt').classList.add('hidden');
                document.getElementById('uploadSuccess').classList.remove('hidden');
                document.getElementById('uploadSuccessText').textContent = `‚úì ${file.name} loaded!`;
                document.getElementById('dataStats').classList.remove('hidden');
                document.getElementById('restaurantSection').classList.remove('hidden');
            };
            reader.readAsText(file);
        }

        function parseCSV(text) {
            const lines = text.split('\n').filter(line => line.trim());
            const headers = lines[0].split(',').map(h => h.trim().replace(/"/g, ''));
            csvData = [];
            for (let i = 1; i < lines.length; i++) {
                const values = parseCSVLine(lines[i]);
                const row = {};
                headers.forEach((header, index) => { row[header] = values[index] || ''; });
                csvData.push(row);
            }
            populateRestaurantDropdown();
            updateDataStats();
        }

        function parseCSVLine(line) {
            const result = [];
            let current = '', inQuotes = false;
            for (let i = 0; i < line.length; i++) {
                const char = line[i];
                if (char === '"') inQuotes = !inQuotes;
                else if (char === ',' && !inQuotes) {
                    result.push(current.trim());
                    current = '';
                } else current += char;
            }
            result.push(current.trim());
            return result;
        }

        function populateRestaurantDropdown() {
            const select = document.getElementById('restaurantSelect');
            select.innerHTML = '<option value="">-- Select Restaurant --</option>';
            csvData.forEach((r, i) => {
                const opt = document.createElement('option');
                opt.value = i;
                opt.textContent = `${r.Name} - ${r.Address}`;
                select.appendChild(opt);
            });
        }

        function updateDataStats() {
            const total = csvData.length;
            const withViol = csvData.filter(r => parseInt(r['Total Violations'] || 0) > 0).length;
            const totalViol = csvData.reduce((sum, r) => sum + parseInt(r['Total Violations'] || 0), 0);
            const criticalViol = csvData.reduce((sum, r) => sum + parseInt(r['Critical Violations'] || 0), 0);
            document.getElementById('statTotal').textContent = total;
            document.getElementById('statViolations').textContent = withViol;
            document.getElementById('statTotalViol').textContent = totalViol;
            document.getElementById('statCritical').textContent = criticalViol;
        }

        document.getElementById('loadRestaurantBtn').addEventListener('click', function() {
            const idx = document.getElementById('restaurantSelect').value;
            if (idx === '') { alert('Select a restaurant first'); return; }
            selectedRestaurant = csvData[idx];
            populateForm(selectedRestaurant);
            document.getElementById('assessmentSection').classList.remove('hidden');
            document.getElementById('assessmentSection').scrollIntoView({ behavior: 'smooth' });
        });

        function populateForm(r) {
            document.getElementById('restaurantName').value = r.Name || '';
            document.getElementById('restaurantId').value = r['Facility ID'] || '';
            document.getElementById('address').value = r.Address || '';
            document.getElementById('licenseType').value = r['License Type'] || '';
            document.getElementById('licenseNumber').value = r['License Number'] || '';
            document.getElementById('lastInspectionDate').value = r['Last Inspection Date'] || '';
            document.getElementById('totalViolations').value = r['Total Violations'] || '0';
            document.getElementById('criticalViolations').value = r['Critical Violations'] || '0';
            document.getElementById('violationDetails').value = r['Violation Details'] || 'None';

            const inspDate = new Date(r['Last Inspection Date']);
            const today = new Date();
            const months = Math.floor((today - inspDate) / (1000 * 60 * 60 * 24 * 30));
            document.getElementById('monthsSinceInspection').value = Math.max(months, 0);

            const tv = parseInt(r['Total Violations'] || 0);
            const cv = parseInt(r['Critical Violations'] || 0);
            const score = Math.max(100 - (tv * 5) - (cv * 10), 0);
            document.getElementById('previousInspectionScore').value = score;

            const lt = (r['License Type'] || '').toLowerCase();
            if (lt.includes('sushi') || lt.includes('seafood')) document.getElementById('cuisineType').value = '1.8';
            else if (lt.includes('coffee') || lt.includes('bakery')) document.getElementById('cuisineType').value = '1.0';
            else document.getElementById('cuisineType').value = '1.4';

            document.getElementById('cgdReviews').value = '0';
            document.getElementById('cgdResults').classList.add('hidden');
            document.getElementById('cgdVerification').classList.add('hidden');
        }

        document.getElementById('fetchCGDBtn').addEventListener('click', async function() {
            if (!selectedRestaurant) { alert('Load restaurant first'); return; }
            const button = this;
            const text = document.getElementById('fetchCGDText');
            const spinner = document.getElementById('cgdSpinner');
            
            button.disabled = true;
            text.textContent = 'Analyzing...';
            spinner.classList.remove('hidden');

            const name = selectedRestaurant.Name;
            const addr = selectedRestaurant.Address;
            
            document.getElementById('cgdVerification').classList.remove('hidden');
            document.getElementById('cgdRestaurantName').textContent = name;
            document.getElementById('cgdRestaurantAddress').textContent = addr;
            
            const city = extractCity(addr);
            const q = encodeURIComponent(`${name} ${city} RI`);
            document.getElementById('yelpLink').href = `https://www.yelp.com/search?find_desc=${q}`;
            document.getElementById('googleLink').href = `https://www.google.com/maps/search/${q}`;
            
            const key = `${name}-${addr}`;
            if (cgdCache[key]) {
                displayCGDResults(cgdCache[key]);
            } else {
                await new Promise(r => setTimeout(r, 2000));
                const data = await fetchAndAnalyzeCGD(name, addr);
                cgdCache[key] = data;
                currentCGDData = data;
                displayCGDResults(data);
            }
            
            button.disabled = false;
            text.textContent = 'Fetch CGD Data';
            spinner.classList.add('hidden');
        });

        function extractCity(addr) {
            const m = addr.match(/([A-Z\s]+)\s+RI\s+\d{5}/);
            return m ? m[1].trim() : '';
        }

        async function fetchAndAnalyzeCGD(name, addr) {
            const reviews = generateSimulatedReviews(name, addr);
            const analysis = analyzeReviews(reviews);
            return {
                restaurantName: name,
                address: addr,
                totalReviews: reviews.length,
                relevantReviews: analysis.relevantCount,
                keywordMatches: analysis.keywords,
                severity: analysis.severity,
                reviews: reviews.filter(r => r.hasConcern)
            };
        }

        function generateSimulatedReviews(name, addr) {
            const viol = parseInt(selectedRestaurant['Total Violations'] || 0);
            const cv = parseInt(selectedRestaurant['Critical Violations'] || 0);
            const vd = selectedRestaurant['Violation Details'] || '';
            const reviews = [];
            const sources = ['Yelp', 'Google Reviews'];

            if (vd.toLowerCase().includes('pest') || vd.toLowerCase().includes('insect')) {
                reviews.push({ text: 'Saw roach near kitchen!', rating: 1, source: sources[0], date: genDate(), hasConcern: true, keywords: ['roach'] });
                reviews.push({ text: 'Bug problem here', rating: 2, source: sources[1], date: genDate(), hasConcern: true, keywords: ['bug'] });
            }
            if (vd.toLowerCase().includes('clean') || vd.toLowerCase().includes('dirty')) {
                reviews.push({ text: 'Tables dirty, unsanitary', rating: 2, source: sources[0], date: genDate(), hasConcern: true, keywords: ['dirty', 'unsanitary'] });
            }
            if (vd.toLowerCase().includes('food') || vd.toLowerCase().includes('temp')) {
                reviews.push({ text: 'Got food poisoning', rating: 1, source: sources[1], date: genDate(), hasConcern: true, keywords: ['food poisoning'] });
                reviews.push({ text: 'Food made me sick', rating: 1, source: sources[0], date: genDate(), hasConcern: true, keywords: ['sick'] });
            }

            const base = 20 + Math.floor(Math.random() * 30);
            while (reviews.length < base) {
                reviews.push({ text: 'Good food', rating: 4, source: sources[Math.floor(Math.random() * 2)], date: genDate(), hasConcern: false, keywords: [] });
            }
            return reviews;
        }

        function genDate() {
            const d = new Date();
            d.setDate(d.getDate() - Math.floor(Math.random() * 180));
            return d.toISOString().split('T')[0];
        }

        function analyzeReviews(reviews) {
            const kw = { high: [], medium: [], low: [] };
            let count = 0;
            reviews.forEach(r => {
                const t = r.text.toLowerCase();
                let match = false;
                Object.keys(CGD_KEYWORDS).forEach(level => {
                    CGD_KEYWORDS[level].forEach(keyword => {
                        if (t.includes(keyword)) {
                            kw[level].push(keyword);
                            match = true;
                            if (!r.keywords.includes(keyword)) r.keywords.push(keyword);
                        }
                    });
                });
                if (match) { count++; r.hasConcern = true; }
            });
            return { relevantCount: count, keywords: kw };
        }

        function displayCGDResults(data) {
            document.getElementById('cgdResults').classList.remove('hidden');
            const kwd = document.getElementById('cgdKeywords');
            kwd.innerHTML = '';
            
            [...new Set(data.keywordMatches.high)].forEach(k => {
                const b = document.createElement('span');
                b.className = 'keyword-badge high';
                b.textContent = k;
                kwd.appendChild(b);
            });
            [...new Set(data.keywordMatches.medium)].forEach(k => {
                const b = document.createElement('span');
                b.className = 'keyword-badge medium';
                b.textContent = k;
                kwd.appendChild(b);
            });
            [...new Set(data.keywordMatches.low)].forEach(k => {
                const b = document.createElement('span');
                b.className = 'keyword-badge low';
                b.textContent = k;
                kwd.appendChild(b);
            });
            
            const sum = document.getElementById('cgdSummary');
            if (data.relevantReviews === 0) {
                sum.innerHTML = '<span class="text-green-600 font-semibold">‚úì No concerns found</span>';
            } else {
                sum.innerHTML = `<span class="text-red-600 font-semibold">‚ö† ${data.relevantReviews} concerning reviews</span>`;
            }
            
            document.getElementById('cgdReviews').value = data.relevantReviews;
            
            const list = document.getElementById('reviewsList');
            list.innerHTML = '';
            data.reviews.slice(0, 5).forEach((r, i) => {
                const div = document.createElement('div');
                div.className = 'review-card p-2 bg-gray-50 rounded border text-xs';
                div.innerHTML = `
                    <div class="flex justify-between mb-1">
                        <span class="font-bold text-gray-500">#${i+1}</span>
                        <span class="text-gray-500">${r.date}</span>
                    </div>
                    <p class="text-gray-700">"${r.text}"</p>
                `;
                list.appendChild(div);
            });
        }

        document.getElementById('riskForm').addEventListener('submit', function(e) {
            e.preventDefault();
            calculateRisk();
        });

        function calculateRisk() {
            const cw = parseFloat(document.getElementById('cuisineType').value);
            const ps = parseInt(document.getElementById('previousInspectionScore').value);
            const v = parseInt(document.getElementById('criticalViolations').value);
            const sp = parseInt(document.getElementById('specializedProcess').value);
            const cm = parseInt(document.getElementById('certifiedManager').value);
            const m = parseInt(document.getElementById('monthsSinceInspection').value);
            const r = parseInt(document.getElementById('cgdReviews').value);

            const wV = v * 15;
            const wPS = (100 - ps) * 1.2;
            const wSP = sp * 10;
            const wCM = cm * 15;
            const wC = (cw - 1.0) * 8;
            const wM = Math.min(m / 3, 5) * 4;
            const wR = Math.min(r * 3, 20);

            const raw = wV + wPS + wSP + wCM + wC + wM + wR;
            const score = Math.min(Math.round(raw), 100);

            displayResults(score, v, m, r, sp, cm, ps);
            
            // Generate predictions
            generatePredictions(score, v, m, r, sp, cm, ps, cw);
        }

        function displayResults(score, v, m, r, sp, cm, ps) {
            document.getElementById('initialMessage').classList.add('hidden');
            document.getElementById('scoreOutput').classList.remove('hidden');
            document.getElementById('guidelinesOutput').classList.remove('hidden');
            document.getElementById('riskScore').textContent = score;

            let tier = '', cardClass = '', textClass = '', guidelines = [];
            if (score >= 70) {
                tier = 'High Risk';
                cardClass = 'bg-red-50 border-red-500';
                textClass = 'text-red-600';
                guidelines = getHighRiskGuidelines(v, m, r, sp, cm, ps);
            } else if (score >= 40) {
                tier = 'Medium Risk';
                cardClass = 'bg-yellow-50 border-yellow-500';
                textClass = 'text-yellow-600';
                guidelines = getMediumRiskGuidelines(v, m, r, sp, cm, ps);
            } else {
                tier = 'Low Risk';
                cardClass = 'bg-green-50 border-green-500';
                textClass = 'text-green-600';
                guidelines = getLowRiskGuidelines(sp, cm, ps);
            }

            document.getElementById('riskScoreCard').className = `text-center p-3 rounded-lg border-2 ${cardClass}`;
            document.getElementById('riskScore').className = `text-3xl font-extrabold mt-1 ${textClass}`;
            document.getElementById('riskTierLabel').innerHTML = `Risk Tier: <span class="font-bold ${textClass}">${tier}</span>`;

            const list = document.getElementById('guidelinesList');
            list.innerHTML = '';
            guidelines.forEach(g => {
                const li = document.createElement('li');
                li.textContent = g;
                list.appendChild(li);
            });
        }

        function generatePredictions(score, v, m, r, sp, cm, ps, cw) {
            document.getElementById('predictiveSection').classList.remove('hidden');

            // Calculate violation probability (0-100%)
            let baseProb = score * 0.85; // Base from current risk
            
            // Adjust for time decay
            const timeFactor = Math.min(m / 12, 1.5); // More time = higher risk
            baseProb += timeFactor * 10;
            
            // Adjust for trend
            const trendFactor = v > 0 ? 1.2 : 0.8; // Recent violations = higher risk
            baseProb *= trendFactor;
            
            // Adjust for management
            if (cm === 1) baseProb += 15; // No manager = much higher risk
            if (sp === 1) baseProb += 10; // Complex processes = higher risk
            
            // Adjust for CGD
            baseProb += r * 2;
            
            // Cap at 95%
            const probability = Math.min(Math.round(baseProb), 95);
            
            // Model confidence (based on data quality)
            const hasRecentInsp = m < 6;
            const hasCGD = r > 0;
            const dataQuality = (hasRecentInsp ? 40 : 20) + (hasCGD ? 30 : 0) + (v > 0 ? 30 : 20);
            const confidence = Math.min(dataQuality, 95);
            
            // Display probability
            document.getElementById('violationProbability').textContent = probability;
            document.getElementById('modelConfidence').textContent = `${confidence}%`;
            document.getElementById('confidenceFill').style.width = `${confidence}%`;
            
            // Position indicator
            const indicatorPos = (probability / 100) * 100;
            document.getElementById('predictionIndicator').style.left = `calc(${indicatorPos}% - 6px)`;
            
            // Timeline predictions
            const t30 = Math.max(10, Math.round(probability * 0.3));
            const t60 = Math.max(15, Math.round(probability * 0.6));
            const t90 = probability;
            
            document.getElementById('pred30').textContent = `${t30}%`;
            document.getElementById('pred60').textContent = `${t60}%`;
            document.getElementById('pred90').textContent = `${t90}%`;
            
            if (t30 > 30) {
                document.getElementById('pred30desc').textContent = 'URGENT: High near-term risk';
                document.getElementById('timeline30').classList.add('active');
            } else if (t30 > 15) {
                document.getElementById('pred30desc').textContent = 'Moderate risk detected';
            } else {
                document.getElementById('pred30desc').textContent = 'Low immediate risk';
            }
            
            if (t60 > 50) {
                document.getElementById('pred60desc').textContent = 'Risk escalating rapidly';
                document.getElementById('timeline60').classList.add('active');
            } else if (t60 > 25) {
                document.getElementById('pred60desc').textContent = 'Risk building gradually';
            } else {
                document.getElementById('pred60desc').textContent = 'Risk remains manageable';
            }
            
            if (t90 > 70) {
                document.getElementById('pred90desc').textContent = 'CRITICAL: Intervention needed';
                document.getElementById('timeline90').classList.add('active');
            } else if (t90 > 40) {
                document.getElementById('pred90desc').textContent = 'Monitor closely';
            } else {
                document.getElementById('pred90desc').textContent = 'Routine oversight sufficient';
            }
            
            // Predicted violation types
            const vd = selectedRestaurant['Violation Details'] || '';
            const predViol = document.getElementById('predictedViolations');
            predViol.innerHTML = '';
            
            const violTypes = [];
            if (vd.toLowerCase().includes('pest') || vd.toLowerCase().includes('insect') || r > 2) {
                violTypes.push({ type: 'Pest Control Issues', prob: Math.min(probability + 10, 95), color: 'red' });
            }
            if (vd.toLowerCase().includes('temp') || vd.toLowerCase().includes('cold') || cm === 1) {
                violTypes.push({ type: 'Temperature Control', prob: Math.min(probability + 5, 95), color: 'red' });
            }
            if (vd.toLowerCase().includes('clean') || vd.toLowerCase().includes('dirty') || m > 8) {
                violTypes.push({ type: 'Sanitation/Cleanliness', prob: Math.min(probability, 95), color: 'yellow' });
            }
            if (cm === 1 || vd.toLowerCase().includes('manager') || vd.toLowerCase().includes('certified')) {
                violTypes.push({ type: 'Food Safety Certification', prob: 85, color: 'red' });
            }
            if (sp === 1) {
                violTypes.push({ type: 'HACCP Compliance', prob: Math.min(probability + 15, 95), color: 'red' });
            }
            if (violTypes.length === 0) {
                violTypes.push({ type: 'Minor Non-Compliance', prob: Math.max(probability - 20, 10), color: 'yellow' });
            }
            
            violTypes.sort((a, b) => b.prob - a.prob);
            violTypes.slice(0, 4).forEach(vt => {
                const div = document.createElement('div');
                div.className = `flex items-center justify-between p-2 rounded bg-${vt.color === 'red' ? 'red' : 'yellow'}-50`;
                div.innerHTML = `
                    <span class="text-xs font-medium text-gray-700">${vt.type}</span>
                    <span class="text-xs font-bold text-${vt.color === 'red' ? 'red' : 'yellow'}-600">${vt.prob}%</span>
                `;
                predViol.appendChild(div);
            });
            
            // Risk indicators
            const indicators = document.getElementById('riskIndicators');
            indicators.innerHTML = '';
            
            const risks = [];
            if (m > 6) risks.push({ icon: '‚è∞', text: `${m} months since inspection - decay factor`, level: 'warning' });
            if (v > 2) risks.push({ icon: 'üö®', text: `${v} critical violations - pattern detected`, level: 'danger' });
            if (r > 3) risks.push({ icon: 'üì±', text: `${r} negative CGD reviews - reputation impact`, level: 'warning' });
            if (cm === 1) risks.push({ icon: '‚ö†Ô∏è', text: 'No certified manager - compliance gap', level: 'danger' });
            if (ps < 80) risks.push({ icon: 'üìâ', text: `Low previous score (${ps}) - historical trend`, level: 'warning' });
            if (sp === 1 && v > 0) risks.push({ icon: 'üî¨', text: 'Specialized processes + violations', level: 'danger' });
            
            if (risks.length === 0) {
                risks.push({ icon: '‚úÖ', text: 'No major risk indicators detected', level: 'success' });
            }
            
            risks.forEach(risk => {
                const div = document.createElement('div');
                const colorClass = risk.level === 'danger' ? 'text-red-600' : risk.level === 'warning' ? 'text-yellow-600' : 'text-green-600';
                div.className = `flex items-center gap-2 ${colorClass}`;
                div.innerHTML = `<span>${risk.icon}</span><span>${risk.text}</span>`;
                indicators.appendChild(div);
            });
        }

        function getHighRiskGuidelines(v, m, r, sp, cm, ps) {
            let list = ['IMMEDIATE: Inspect within 7-14 days', 'High failure probability'];
            if (ps < 80) list.push(`Past failure (score ${ps})`);
            if (v > 2) list.push(`${v} critical violations`);
            if (cm === 1) list.push('No manager - enforcement required');
            if (r > 3) list.push(`${r} negative reviews`);
            list.push('Require Corrective Action Plan');
            return list;
        }

        function getMediumRiskGuidelines(v, m, r, sp, cm, ps) {
            let list = ['Schedule inspection within 90 days', 'Consider spot-check'];
            if (v > 0) list.push(`Resolve ${v} violations`);
            if (m > 6) list.push('Risk increasing over time');
            if (r > 0) list.push(`${r} reviews indicate issues`);
            return list;
        }

        function getLowRiskGuidelines(sp, cm, ps) {
            let list = ['Routine schedule', 'Monitor passively'];
            if (ps > 95) list.push(`Excellent score (${ps})`);
            return list;
        }
    </script>
</body>
</html>
